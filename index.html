<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCheck - School OS v87</title>
    <meta name="theme-color" content="#050b14">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CORE */
        body { font-family: 'Inter', sans-serif; background-color: #050b14; -webkit-tap-highlight-color: transparent; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: rgba(20, 27, 45, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .hidden { display: none !important; }
        input[type="date"] { color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* STATUS INDICATOR */
        #db-indicator { position: fixed; top: 10px; right: 10px; width: 10px; height: 10px; border-radius: 50%; z-index: 9999; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .db-ok { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .db-err { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .db-load { background-color: #eab308; animation: pulse 1s infinite; }

        /* STATUS COLORS */
        .status-bagno { border: 1px solid #06b6d4 !important; background: linear-gradient(145deg, rgba(8, 51, 68, 0.9), rgba(22, 78, 99, 0.4)) !important; color: #67e8f9 !important; animation: pulse 2s infinite; }
        .status-presente { border: 1px solid #22c55e !important; background: linear-gradient(145deg, rgba(20, 83, 45, 0.5), rgba(5, 46, 22, 0.7)) !important; color: #4ade80 !important; }
        .status-assente { border: 1px solid #ef4444 !important; background: rgba(127, 29, 29, 0.2) !important; color: #ef4444 !important; opacity: 0.6; }
        .status-ritardo { border: 1px solid #f97316 !important; background: linear-gradient(145deg, rgba(67, 20, 7, 0.6), rgba(124, 45, 18, 0.2)) !important; color: #fdba74 !important; }
        .status-seconda-ora { border: 1px solid #8b5cf6 !important; background: linear-gradient(145deg, rgba(76, 29, 149, 0.6), rgba(109, 40, 217, 0.2)) !important; color: #c4b5fd !important; }
        .status-uscita-anticipata { border: 1px solid #eab308 !important; background: linear-gradient(145deg, rgba(66, 32, 6, 0.6), rgba(113, 63, 18, 0.2)) !important; color: #fde047 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(6,182,212,0.4); } 70% { box-shadow: 0 0 0 10px rgba(6,182,212,0); } 100% { box-shadow: 0 0 0 0 rgba(6,182,212,0); } }

        /* TOOLS */
        .tool-btn { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); width: 70px; height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 18px; cursor: pointer; transition: all 0.2s; }
        .tool-btn:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.3); background: rgba(30, 41, 59, 1); }
        .tool-btn span { font-family: 'JetBrains Mono', monospace; font-size: 9px; font-weight: 800; letter-spacing: 0.5px; margin-top: 8px; text-transform: uppercase; }
        .tool-agenda { border-bottom: 3px solid #ec4899; } .tool-bacheca { border-bottom: 3px solid #eab308; } .tool-voti { border-bottom: 3px solid #66cc00; }

        /* GRADES & UI */
        .cv-header { color: white; transition: background-color 0.4s ease; }
        .cv-card { background: #111; border: 1px solid #333; border-radius: 12px; transition: background 0.2s; }
        .cv-card:hover { background: #1a1a1a; }
        .grade-circle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; position: relative; }
        .grade-circle::before { content: ''; position: absolute; inset: 6px; background: #111; border-radius: 50%; }
        .grade-value { position: relative; z-index: 10; font-size: 14px; }
        
        .g-green { background: conic-gradient(#22c55e var(--percent), #333 0); } .text-g-green { color: #4ade80; } .bg-cv-green { background-color: #22c55e; }
        .g-orange { background: conic-gradient(#f97316 var(--percent), #333 0); } .text-g-orange { color: #fb923c; } .bg-cv-orange { background-color: #f97316; }
        .g-red { background: conic-gradient(#ef4444 var(--percent), #333 0); } .text-g-red { color: #f87171; } .bg-cv-red { background-color: #ef4444; }

        .btn-selected { opacity: 1 !important; transform: scale(1.05) !important; border: 2px solid white !important; box-shadow: 0 0 15px rgba(255,255,255,0.2); z-index: 10; }
        .status-btn { opacity: 0.5; transition: all 0.2s; border-width: 1px; transform: scale(0.98); }
        .hour-selected { background-color: #2563eb !important; color: white !important; border-color: #3b82f6 !important; }
        .cv-event { border-left-width: 4px; background: rgba(30, 41, 59, 0.5); transition: transform 0.2s; position: relative; }
        .grade-details { border-top: 1px solid #333; background: #0a0a0a; border-radius: 0 0 12px 12px; overflow: hidden; }

        /* CALENDAR STRIP */
        .cv-calendar-strip { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .cv-day { display: flex; flex-direction: column; align-items: center; gap: 6px; width: 40px; cursor: pointer; transition: all 0.3s; opacity: 0.5; }
        .cv-day.active { opacity: 1; transform: scale(1.1); }
        .cv-day.today { opacity: 1; } 
        .cv-day-letter { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; }
        .cv-day-number { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 800; font-size: 14px; color: white; transition: all 0.3s; border: 2px solid transparent; }
        .cv-day.active .cv-day-number { background-color: #ef4444; color: white; border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); }
        .cv-day.today:not(.active) .cv-day-number { border: 2px solid #ef4444; color: #ef4444; }
        .cv-day.future { opacity: 0.2; pointer-events: none; filter: grayscale(1); }
        .cv-day:not(.active):not(.future):hover .cv-day-number { background-color: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col overflow-x-hidden selection:bg-blue-500">

    <div id="db-indicator" class="db-load" title="Stato Database"></div>

    <div id="view-login" class="fixed inset-0 z-[100] bg-[#050b14] flex items-center justify-center p-4">
        <div class="relative z-10 w-full max-w-5xl h-[600px] glass-panel rounded-3xl overflow-hidden flex shadow-2xl fade-in">
            <div class="w-1/2 bg-gradient-to-br from-blue-600/20 to-purple-900/40 p-12 flex flex-col justify-between relative border-r border-white/5">
                <div>
                    <h1 class="text-6xl font-black italic text-white tracking-tighter mb-4"><span class="text-blue-500">SMART</span><br>CHECK.</h1>
                    <div class="w-20 h-1 bg-blue-500 rounded-full mb-6"></div>
                    <p class="text-slate-300 font-light text-lg">Il sistema operativo scolastico<br>di nuova generazione.</p>
                </div>
                <div class="text-xs font-mono text-slate-500">v87.0 • Final Edition</div>
            </div>
            <div class="w-1/2 p-12 flex flex-col justify-center items-center bg-[#0a0f1c]/80">
                <div class="w-full max-w-xs space-y-8">
                    <div class="text-center"><h2 class="text-2xl font-bold text-white mb-1">Accesso</h2><p class="text-slate-400 text-sm">Inserisci le tue credenziali</p></div>
                    <div id="login-form" class="space-y-5">
                        <input type="text" id="input-username" placeholder="cognome.nome" class="w-full bg-[#131b2e] border border-slate-700 text-white px-5 py-4 rounded-xl focus:border-blue-500 outline-none text-center font-bold lowercase transition-all">
                        <div id="password-container" class="hidden space-y-5">
                            <p class="text-center text-sm font-bold text-blue-400 uppercase tracking-widest" id="user-welcome">--</p>
                            <input type="password" id="input-password" placeholder="Password (Il tuo Nome)" class="w-full bg-[#131b2e] border border-slate-700 text-white px-5 py-4 rounded-xl focus:border-blue-500 outline-none text-center">
                            <button id="btn-login-final" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg transform hover:scale-[1.02]">ENTRA</button>
                            <button onclick="resetLogin()" class="w-full text-xs text-slate-500 hover:text-white underline">Indietro</button>
                        </div>
                        <button id="btn-next" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">CONTINUA <i class="fa-solid fa-arrow-right ml-2"></i></button>
                    </div>
                    <p id="login-error" class="text-red-400 text-xs font-bold text-center hidden bg-red-900/20 p-2 rounded border border-red-900/50"><i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="error-text">Credenziali Errate</span></p>
                </div>
                <button onclick="hardReset()" class="mt-12 text-[9px] text-slate-600 hover:text-red-400 font-mono transition-colors italic border-b border-transparent hover:border-red-400">Resetta Dati Browser</button>
            </div>
        </div>
    </div>

    <div id="view-hub" class="hidden min-h-screen p-8 fade-in">
        <header class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
            <div><h2 class="text-3xl font-black text-white italic">HUB <span class="text-blue-500">ISTITUTO</span></h2><div class="flex gap-2 mt-1"><span id="hub-role-badge" class="text-[10px] font-bold px-2 py-0.5 rounded border border-slate-700 uppercase tracking-widest text-slate-400">--</span><span id="hub-user-name" class="text-sm text-slate-300 font-bold">--</span></div></div>
            <button onclick="logout()" class="px-5 py-2 bg-red-900/20 border border-red-500/30 rounded-xl text-red-400 hover:bg-red-500 hover:text-white transition-all text-xs font-black">ESCI</button>
        </header>
        <div class="glass-panel p-10 rounded-3xl border border-slate-700/50"><div class="flex gap-12 overflow-x-auto pb-4 custom-scrollbar" id="classes-container"></div></div>
    </div>

    <div id="view-classroom" class="hidden min-h-screen flex flex-col relative fade-in">
        <header class="bg-[#0b1121]/90 backdrop-blur-md border-b border-slate-800 px-8 py-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-6">
                <button id="back-btn" onclick="backToHub()" class="p-2.5 bg-slate-800 rounded-xl hover:bg-slate-700 text-slate-400 transition-all"><i class="fa-solid fa-arrow-left"></i></button>
                <div><h1 class="text-2xl font-black text-white italic tracking-tight"><span class="text-blue-500">CLASSE</span> <span id="class-header-name">--</span></h1><div class="flex items-center gap-2 text-[10px] font-bold mt-1"><span id="role-badge" class="px-2 py-0.5 rounded bg-blue-900/50 text-blue-300 border border-blue-700/50 uppercase tracking-widest">--</span></div></div>
            </div>
            <div class="relative group mx-4">
                <div class="glass-panel px-5 py-2.5 rounded-xl flex items-center gap-3 cursor-pointer border border-slate-700 hover:border-blue-500 transition-all" onclick="resetToToday()">
                    <i class="fa-regular fa-calendar text-blue-400 text-lg"></i>
                    <div class="flex flex-col text-right"><span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest leading-none mb-1">DATA</span><span id="date-display" class="font-mono text-sm font-bold text-white leading-none uppercase">Oggi</span></div>
                    <input type="date" id="date-picker" class="absolute inset-0 opacity-0 cursor-pointer" onchange="changeDate(this.value)">
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openListModal()" class="px-5 py-2.5 bg-slate-800 border border-slate-600 rounded-xl text-xs font-bold text-slate-300 hover:bg-slate-700 uppercase tracking-wider transition-all"><i class="fa-solid fa-list-ul mr-2"></i>ELENCO</button>
                <button id="sign-btn" onclick="openSignModal()" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-bold uppercase tracking-wider shadow-lg transition-all"><i class="fa-solid fa-book-open mr-2"></i>REGISTRO</button>
                <button onclick="logout()" class="px-3 py-2.5 bg-red-900/10 text-red-400 border border-red-900/30 rounded-xl text-xs font-bold hover:bg-red-900/30 transition-all ml-2">ESCI</button>
                <div class="text-right border-l border-slate-700 pl-6 ml-2">
                    <div id="clock" class="mono text-2xl font-bold text-slate-200">00:00:00</div>
                    <div id="hour-badge" class="text-[10px] text-purple-400 font-bold uppercase tracking-widest text-right leading-none">--</div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex flex-col items-center w-full px-4 pb-40 pt-8">
            <div id="loading-grid" class="hidden py-32 text-center"><div class="loader mb-4"></div><p class="text-slate-500 text-xs font-mono uppercase tracking-widest">Sincronizzazione Cloud...</p></div>
            <div id="history-warning" class="hidden w-full max-w-md bg-yellow-900/20 border border-yellow-500/30 rounded-full py-2 px-6 mb-8 flex items-center justify-center gap-3 text-yellow-400 backdrop-blur-sm animate-pulse"><i class="fa-solid fa-clock-rotate-left"></i> <span class="text-xs font-black uppercase tracking-widest">Visualizzazione Archivio</span></div>
            <div id="bathroom-bar" class="w-full max-w-2xl mb-6 flex justify-center"></div>
            <div class="grid grid-cols-3 gap-24 w-full max-w-[95%]" id="classroom-grid"></div>
            <div onclick="openSignModal()" class="mt-24 w-[450px] h-24 bg-[#1e293b]/90 backdrop-blur border-b-4 border-blue-500 rounded-3xl flex flex-col items-center justify-center shadow-2xl px-4 cursor-pointer hover:scale-105 transition-transform group">
                <span class="text-2xl font-black tracking-[0.4em] text-blue-400 uppercase">Cattedra</span>
                <span id="signature-display" class="text-xs text-slate-400 font-mono mt-2 w-full text-center truncate group-hover:text-blue-300">Clicca per Registro</span>
            </div>
        </main>

        <div class="fixed bottom-8 left-8 z-50 flex gap-6">
            <div onclick="openAgendaModal()" class="tool-btn tool-agenda group"><i class="fa-solid fa-calendar-check text-pink-500 group-hover:text-pink-400 text-2xl mb-1"></i><span class="text-slate-400 group-hover:text-white">AGENDA</span></div>
            <div onclick="toggleNoticeModal()" class="tool-btn tool-bacheca group"><i class="fa-solid fa-bullhorn text-yellow-500 group-hover:text-yellow-400 text-2xl mb-1"></i><span class="text-slate-400 group-hover:text-white">AVVISI</span></div>
        </div>
        <div id="dock-right" class="fixed bottom-8 right-8 z-50 hidden">
            <div onclick="openGradesModal()" class="tool-btn tool-voti group"><i class="fa-solid fa-chart-pie text-[#66cc00] group-hover:text-green-400 text-2xl mb-1"></i><span class="text-slate-400 group-hover:text-white">VOTI</span></div>
        </div>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[45%] max-w-3xl glass-panel px-8 py-4 rounded-full flex flex-wrap justify-between items-center shadow-2xl z-40 border border-slate-700/50 backdrop-blur-xl">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span> Presente</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-cyan-400 animate-pulse"></span> Bagno</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-violet-500"></span> 2° Ora</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span> Uscita</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full border border-red-500 bg-red-900/20"></span> Assente</div>
        </div>
    </div>

    <div id="modal-agenda" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="glass-panel w-full max-w-2xl h-[75vh] p-8 rounded-3xl shadow-2xl flex flex-col border border-slate-700"><div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700"><h2 class="text-2xl font-black text-white italic"><span class="text-pink-500">AGENDA</span> CLASSE</h2><div class="flex gap-3"><button id="btn-add-agenda" onclick="openAddAgendaModal()" class="hidden px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-xs font-bold uppercase tracking-wider">Nuovo +</button><button onclick="document.getElementById('modal-agenda').classList.add('hidden')" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-lg">✕</button></div></div><div class="flex gap-4 mb-4"><div class="bg-slate-800 px-4 py-2 rounded text-xs font-bold text-slate-300 border-l-4 border-green-500 uppercase">Compiti</div><div class="bg-slate-800 px-4 py-2 rounded text-xs font-bold text-slate-300 border-l-4 border-red-500 uppercase">Verifiche</div></div><div class="overflow-y-auto flex-grow custom-scrollbar"><div id="agenda-list" class="space-y-3"></div></div></div></div>
    
    <div id="modal-add-agenda" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl relative">
            <button onclick="document.getElementById('modal-add-agenda').classList.add('hidden')" class="absolute top-6 right-6 text-slate-400 hover:text-white text-xl z-50">✕</button>
            <h2 class="text-xl font-bold text-white mb-6 uppercase">Nuovo Impegno</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4"><button onclick="selectAgendaType('compito')" id="btn-type-compito" class="py-3 bg-slate-800 border border-green-500/30 text-green-400 font-bold rounded-xl hover:bg-green-900/20 transition">COMPITO</button><button onclick="selectAgendaType('verifica')" id="btn-type-verifica" class="py-3 bg-slate-800 border border-red-500/30 text-red-400 font-bold rounded-xl hover:bg-red-900/20 transition">VERIFICA</button></div>
                <div><label class="text-[10px] text-slate-500 uppercase font-bold">Data</label><input type="date" id="agenda-date" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl mt-1"></div>
                <div><label class="text-[10px] text-slate-500 uppercase font-bold">Materia</label><select id="agenda-subject" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl mt-1"></select></div>
                <div><label class="text-[10px] text-slate-500 uppercase font-bold">Descrizione</label><textarea id="agenda-desc" rows="3" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl mt-1" placeholder="Cosa studiare..."></textarea></div>
                <div class="flex gap-2 mt-4"><button onclick="saveAgendaEntry()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-500">SALVA</button></div>
            </div>
        </div>
    </div>
    
    <div id="modal-notices" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="glass-panel w-full max-w-2xl h-[75vh] p-8 rounded-3xl shadow-2xl flex flex-col border border-slate-700"><div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700"><h2 class="text-2xl font-black text-white italic uppercase"><span class="text-yellow-500">Bacheca</span> Istituto</h2><button onclick="toggleNoticeModal()" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-lg">✕</button></div><div class="overflow-y-auto flex-grow space-y-3" id="modal-notices-list"></div></div></div>
    
    <div id="modal-grades" class="hidden fixed inset-0 z-[85] flex items-center justify-center bg-black/90 backdrop-blur-sm"><div class="bg-[#0f172a] w-full max-w-md h-[80vh] rounded-3xl overflow-hidden shadow-2xl border border-slate-700 flex flex-col"><div id="grades-header-bg" class="cv-header p-6 pb-8 bg-cv-green"><div class="flex justify-between items-start"><h2 class="text-2xl font-black uppercase">Valutazioni</h2><button onclick="document.getElementById('modal-grades').classList.add('hidden')" class="text-white/80 hover:text-white text-xl">✕</button></div><div class="mt-4 flex items-center justify-between"><div><div class="text-sm font-bold opacity-90">Media Generale</div><div class="text-xs opacity-75 mt-1" id="grades-total-count">0 valutazioni</div></div><div class="w-20 h-20 rounded-full border-4 border-white/30 flex items-center justify-center text-3xl font-black bg-white/10" id="grades-total-avg">0.0</div></div></div><div class="bg-[#0f172a] flex-grow overflow-y-auto p-4 space-y-3 custom-scrollbar" id="grades-list"></div></div></div>
    <div id="modal-class-list" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="glass-panel w-full max-w-2xl h-[80vh] p-8 rounded-3xl shadow-2xl flex flex-col border border-slate-700"><div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700"><h2 class="text-2xl font-black text-white italic uppercase tracking-tighter">ELENCO <span id="list-class-name" class="text-blue-500"></span></h2><button onclick="document.getElementById('modal-class-list').classList.add('hidden')" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-lg">✕</button></div><input type="text" id="list-search" placeholder="Cerca studente..." onkeyup="filterListModal()" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl focus:border-blue-500 outline-none mb-4"><div class="overflow-y-auto flex-grow custom-scrollbar"><ul id="full-student-list" class="space-y-2"></ul></div></div></div>
    
    <div id="modal-sign" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-xl p-8 rounded-3xl shadow-2xl max-h-[85vh] flex flex-col border border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-black text-white uppercase tracking-wider" id="reg-title">Registro</h2>
                <button onclick="document.getElementById('modal-sign').classList.add('hidden')" class="text-slate-400 hover:text-white">✕</button>
            </div>
            <div id="cv-calendar-container" class="cv-calendar-strip px-2"></div>
            <div class="flex-grow overflow-y-auto custom-scrollbar mb-6 bg-slate-900/50 rounded-lg p-4 border border-slate-700 min-h-[200px]">
                <div id="signatures-list" class="space-y-4"></div>
                <div id="no-signatures" class="flex flex-col items-center justify-center h-full text-slate-500 opacity-50 py-10">
                    <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
                    <span class="text-xs font-bold uppercase tracking-widest">Nessuna attività registrata</span>
                </div>
            </div>
            <div id="new-signature-form" class="border-t border-slate-700 pt-4 hidden">
                <h3 class="text-xs font-bold text-blue-400 uppercase mb-3">Nuova Firma</h3>
                <div class="flex gap-2 mb-3">
                    <button onclick="selectSignHour(1)" id="hour-btn-1" class="flex-1 py-1.5 rounded bg-slate-800 border border-slate-600 text-xs font-bold hover:bg-slate-700 text-slate-300 transition">1</button>
                    <button onclick="selectSignHour(2)" id="hour-btn-2" class="flex-1 py-1.5 rounded bg-slate-800 border border-slate-600 text-xs font-bold hover:bg-slate-700 text-slate-300 transition">2</button>
                    <button onclick="selectSignHour(3)" id="hour-btn-3" class="flex-1 py-1.5 rounded bg-slate-800 border border-slate-600 text-xs font-bold hover:bg-slate-700 text-slate-300 transition">3</button>
                    <button onclick="selectSignHour(4)" id="hour-btn-4" class="flex-1 py-1.5 rounded bg-slate-800 border border-slate-600 text-xs font-bold hover:bg-slate-700 text-slate-300 transition">4</button>
                    <button onclick="selectSignHour(5)" id="hour-btn-5" class="flex-1 py-1.5 rounded bg-slate-800 border border-slate-600 text-xs font-bold hover:bg-slate-700 text-slate-300 transition">5</button>
                </div>
                <div class="space-y-3">
                    <div class="relative"><input type="text" id="subject-search" placeholder="Materia..." onkeyup="filterSubjects()" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-2 rounded-lg outline-none focus:border-blue-500 text-sm"><div id="subject-dropdown" class="absolute z-10 w-full bg-slate-800 border border-slate-600 mt-1 rounded-lg max-h-32 overflow-y-auto hidden shadow-xl"></div></div>
                    <textarea id="sign-argomento" class="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg text-sm" rows="2" placeholder="Argomento..."></textarea>
                    <button onclick="saveSignature()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-500 uppercase text-xs">Salva Firma</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-student-detail" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-sm"><div class="bg-[#0f172a] w-full max-w-3xl rounded-3xl p-8 border border-slate-700 shadow-2xl relative"><div class="flex justify-between items-start mb-6"><div><h2 id="modal-detail-name" class="text-4xl font-black text-white tracking-tight">Nome Cognome</h2><div class="flex gap-4 mt-4 text-xs font-bold uppercase tracking-widest"><button onclick="switchTab('presence')" id="tab-presence" class="text-blue-400 border-b-2 border-blue-400 pb-1">Presenze</button><button onclick="switchTab('grades')" id="tab-grades" class="text-slate-500 hover:text-white pb-1">Voti</button><button onclick="switchTab('notes')" id="tab-notes" class="text-slate-500 hover:text-white pb-1">Note</button></div></div><button onclick="document.getElementById('modal-student-detail').classList.add('hidden')" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white">✕</button></div>
    
    <div id="content-presence"><div class="grid grid-cols-2 gap-6 mb-8"><div id="status-card" class="bg-[#1e293b]/50 p-6 rounded-2xl border border-slate-700 group transition-all"><div class="text-[10px] text-slate-400 font-bold uppercase mb-2">Stato Attuale</div><div id="status-view-mode" class="cursor-pointer"><div id="modal-detail-status" class="text-3xl font-black text-white">--</div><div id="status-edit-hint" class="hidden text-[10px] text-blue-400 mt-2 font-mono items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen"></i> CLICCA PER MODIFICARE</div></div><div id="status-edit-mode" class="hidden"><div class="grid grid-cols-2 gap-2 mt-1"><button onclick="selectStatusPreview('presente')" id="btn-presente" class="status-btn py-2 text-xs font-bold bg-green-900/40 text-green-400 border border-green-600/50 rounded">PRESENTE</button><button onclick="selectStatusPreview('bagno')" id="btn-bagno" class="status-btn py-2 text-xs font-bold bg-cyan-900/40 text-cyan-400 border border-cyan-600/50 rounded">BAGNO</button><button onclick="selectStatusPreview('ritardo')" id="btn-ritardo" class="status-btn py-2 text-xs font-bold bg-orange-900/40 text-orange-400 border border-orange-600/50 rounded">RITARDO</button><button onclick="selectStatusPreview('seconda_ora')" id="btn-seconda_ora" class="status-btn py-2 text-xs font-bold bg-violet-900/40 text-violet-400 border border-violet-600/50 rounded">2° ORA</button><button onclick="selectStatusPreview('uscita_anticipata')" id="btn-uscita_anticipata" class="status-btn py-2 text-xs font-bold bg-yellow-900/40 text-yellow-400 border border-yellow-600/50 rounded">USCITA</button><button onclick="selectStatusPreview('assente')" id="btn-assente" class="status-btn py-2 text-xs font-bold bg-red-900/40 text-red-400 border border-red-600/50 rounded">ASSENTE</button></div><div class="flex gap-2 mt-3"><button onclick="confirmStatusChange()" class="flex-grow py-3 bg-blue-600 text-white font-bold text-xs rounded-lg uppercase tracking-wider shadow-lg">APPLICA</button><button onclick="toggleStatusEdit()" class="px-4 py-3 bg-slate-700 text-slate-300 font-bold text-xs rounded-lg">✕</button></div></div></div><div class="bg-[#1e293b]/50 p-6 rounded-2xl border border-slate-700 flex flex-col justify-center"><div class="text-[10px] text-slate-400 font-bold uppercase mb-2">Uscite</div><div id="modal-detail-count" class="text-4xl font-black text-white">0</div></div></div><div class="bg-[#1e293b] rounded-xl overflow-hidden border border-slate-700/50"><table class="w-full text-left text-sm font-mono text-slate-300"><thead class="bg-slate-800 text-[10px] uppercase font-bold text-slate-400"><tr><th class="px-6 py-3">Uscita</th><th class="px-6 py-3">Rientro</th><th class="px-6 py-3 text-right">Stato</th></tr></thead><tbody id="modal-history-body" class="divide-y divide-slate-800"></tbody></table></div></div>
    <div id="content-grades" class="hidden"><div id="teacher-subject-block" class="mb-4 text-center"><span class="text-xs font-bold text-slate-500 uppercase">Materia:</span><select id="grade-subject-select" class="ml-2 bg-slate-900 border border-slate-600 text-white rounded p-1 text-xs font-bold uppercase"><option>Generale</option></select></div><div id="grade-input-area" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6 flex gap-4 items-end"><div class="flex-grow"><label class="text-[10px] text-slate-400 font-bold uppercase">Voto</label><select id="new-grade-value" class="w-full bg-slate-900 border border-slate-600 text-white rounded-lg p-2 font-mono font-bold text-sm"><option value="10">10</option><option value="9.75">10-</option><option value="9.5">9 1/2</option><option value="9.25">9+</option><option value="9">9</option><option value="8.75">9-</option><option value="8.5">8 1/2</option><option value="8.25">8+</option><option value="8">8</option><option value="7.75">8-</option><option value="7.5">7 1/2</option><option value="7.25">7+</option><option value="7">7</option><option value="6.75">7-</option><option value="6.5">6 1/2</option><option value="6.25">6+</option><option value="6">6</option><option value="5.75">6-</option><option value="5.5">5 1/2</option><option value="5.25">5+</option><option value="5">5</option><option value="4.75">5-</option><option value="4.5">4 1/2</option><option value="4.25">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div><div class="flex-grow"><label class="text-[10px] text-slate-400 font-bold uppercase">Tipo</label><select id="new-grade-type" class="w-full bg-slate-900 border border-slate-600 text-white rounded-lg p-2 text-sm"><option>Scritto</option><option>Orale</option><option>Pratico</option></select></div><button onclick="addGrade()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-500 h-10 uppercase text-xs">Aggiungi</button></div><div class="bg-[#1e293b] rounded-xl border border-slate-700/50 max-h-64 overflow-y-auto"><table class="w-full text-left"><thead class="bg-slate-800 text-[10px] uppercase font-bold text-slate-400"><tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Materia</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3 text-right">Voto</th><th class="px-6 py-3"></th></tr></thead><tbody id="teacher-grades-list" class="text-sm font-mono text-slate-300 divide-y divide-slate-800"></tbody></table></div></div>
    <div id="content-notes" class="hidden"><div id="teacher-note-input" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6"><textarea id="note-text" class="w-full bg-slate-900 border border-slate-600 text-white rounded-lg p-3 text-sm mb-3" rows="3" placeholder="Scrivi una nota..."></textarea><div class="flex justify-between items-center"><select id="note-type" class="bg-slate-900 border border-slate-600 text-white rounded-lg p-2 text-xs font-bold uppercase"><option value="info">Annotazione</option><option value="warning">Richiamo</option></select><button onclick="addNote()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-500 text-xs uppercase">Salva</button></div></div><div class="bg-[#1e293b] rounded-xl border border-slate-700/50 max-h-64 overflow-y-auto"><div id="notes-list" class="p-4 space-y-3"></div></div></div></div></div>

    <script>
        // CONFIGURAZIONE SUPABASE
        const SUPABASE_URL = 'https://axlfuzksfpfwdvjawlmf.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4bGZ1emtzZnBmd2R2amF3bG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzYyMzYsImV4cCI6MjA4NDUxMjIzNn0.Xga9UIWfS8rYxGYZs-Cz446GZkVhPCxeUvV8UUTlXEg';
        
        // VARIABILI GLOBALI
        let supabase = null;
        let localCache = {}; // Cache dati per interfaccia veloce
        let currentUser = null;
        let tempUser = null;
        let currentClass = null;
        let selectedStudentId = null;
        let pendingStatus = null;
        let selectedSignHour = null;
        let pendingAgendaType = null;
        
        // INIT SAFE
        try {
            supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            document.getElementById('db-indicator').className = 'db-ok';
            console.log("Supabase OK");
        } catch(e) {
            document.getElementById('db-indicator').className = 'db-err';
            console.error("Supabase Fail", e);
        }

        const STUDENTS_4AEE=["Emiliano Calò","Antonio Navarroli","Filippo Agnitti","Ivan Garofalo","Mattia Galli","Lorenzo Esposito","Kristian Methasa","Stefano Spaczil","Federico Pasqualone","Leonardo Pacchione","Oleksandr Tsikhanskyi","Alessio Tofano","Pierpaolo Carosa","Stefano Camassa","Lorenzo Pisone","Abdula Chackari","Ernest Cupi","Matteo Di Michele","Luca Iarossi","Biagio Recchione","Luigi Mirandola","Mattia Raulli","Giuseppe Palombizio"];
        const TEACHERS_NAMES=["Antonini Tania","Caputo Tonino","Cardilli Giuseppina","Centofanti Pietro","Chiarelli Sandra","Consalvo Simone","De Michele Alessandra","Del Fattore Alice","Di Bacco Emilio","Di Cioccio Felicia","Di Giacomo Pierluigi","Di Marzio Cinzia","Di Mascio Stefano","Di Tella Arianna","Fabrizi Paola","Federico Anna Lucia","Giammarco Fulvia","Guadagnoli Francesco","Liberatore Walter","Manna Valeria","Mariani Monica","Marinucci Chiara","Mascio Fabio","Mascitti Valentina","Mazzara Lucia","Natarelli Francesco","Oddi Pasqualina","Paciocco Marco","Pasqua Franca","Perinetti Tullio","Petrilli Antonio","Piccirilli Stefania","Recanati Giulia","Rizzo Sabrina","Roselli Michele","Rucci Piero","Sabatini Leonardo","Sambuco Nazzareno","Santangelo Marco","Santarelli Fabrizio","Santilli Mirco","Scarsella Alessio","Schiavo Marina","Sciarra Santa","Stampone Agata","Trabucco Silvia","Vallera Alessandra","D'Urbano Antonio","De Dominicis Giovanni","Di Bacco Antonio","Di Cesare Paqualino","Di Nino Ivan","Febbo Katia","Liberatore Piergiuseppe","Pace Dino","Tedeschi Diletta","Vallera Villiam"];
        const ALL_SUBJECTS=["Chimica analitica","Chimica organica","Complementi di matematica","Diritto","DPOI","Elettrotecnica","Fisica","Geografia","Inglese","Italiano","Matematica","Religione","Scienze","Scienze motorie","Sistemi Automatici","Sistemi e automazione","STA","Storia","Supplenza","Tecnologie chimiche","Tecnologie informatiche","Tecnologie meccaniche","TPSEE","TTRG"];
        const TEACHER_SUBJECT_MAP = { "Petrilli Antonio": "Sistemi Automatici", "Mascio Fabio": "Elettrotecnica", "Roselli Michele": "TPSEE", "Manna Valeria": "Italiano", "Santilli Mirco": "Matematica", "Di Tella Arianna": "Inglese" };
        const CLASSES_STRUCT={ "ELETTRONICA":["1AEE","2AEE","3AEE","4AEE","5AEE"], "MECCANICA":["1AMM","2AMM","3AMM","4AMM","5AMM","4 MAUT","4 MROB","5 MA/R", "1 MA/R", "2 MA/R", "3 MA/R"], "CHIMICA":["1ACM","2ACM","3ACM","4ACM","5ACM"] };
        const getTodayStr = () => new Date().toLocaleDateString('it-IT', {year: 'numeric', month: '2-digit', day: '2-digit'}).split('/').reverse().join('-');
        let selectedDate = getTodayStr();

        // 1. GESTIONE EVENTI (DOPO IL CARICAMENTO)
        window.onload = function() {
            if(localStorage.getItem('SC_USER')) {
                currentUser = JSON.parse(localStorage.getItem('SC_USER'));
                document.getElementById('view-login').classList.add('hidden');
                if (currentUser.role === 'stud') loadClassroom('4AEE'); else initHub();
                startClock();
            } else {
                document.getElementById('input-username').addEventListener('keypress', (e) => { if(e.key === 'Enter') verifyUser(); });
                document.getElementById('input-password').addEventListener('keypress', (e) => { if(e.key === 'Enter') processAuth(); });
                document.getElementById('btn-next').onclick = verifyUser;
                document.getElementById('btn-login-final').onclick = processAuth;
            }
        };

        // 2. FUNZIONI DI LOGIN (SOLO LOCALI)
        function generateUsername(fullName, isStudent) {
            const cleanName = fullName.toLowerCase().replace("ò","o").replace("à","a").replace("'","");
            const parts = cleanName.split(" ");
            if(isStudent) return `${parts[1]}.${parts[0]}`; else return `${parts[0]}.${parts[1]}`;
        }
        function verifyUser(){ 
            const input = document.getElementById('input-username').value.trim().toLowerCase();
            if(!input) { alert("Inserisci utente"); return; }

            let role = null; let name = "";

            if(input === 'admin') { role = 'admin'; name = 'Amministratore'; }
            else {
                let foundProf = TEACHERS_NAMES.find(n => generateUsername(n, false) === input);
                if(foundProf) { role="prof"; name=foundProf; }
                else {
                    let foundStud = STUDENTS_4AEE.find(n => generateUsername(n, true) === input);
                    if(foundStud) { role="stud"; name=foundStud; }
                }
            }

            if(role) {
                tempUser = { u: input, role: role, name: name };
                document.getElementById('btn-next').classList.add('hidden');
                document.getElementById('input-username').classList.add('hidden');
                document.getElementById('password-container').classList.remove('hidden');
                document.getElementById('user-welcome').innerText = name;
                document.getElementById('login-error').classList.add('hidden');
                setTimeout(() => document.getElementById('input-password').focus(), 100);
            } else {
                document.getElementById('error-text').innerText = "Utente non trovato";
                document.getElementById('login-error').classList.remove('hidden');
            }
        }
        function processAuth(){
            const inputPass = document.getElementById('input-password').value;
            let correctPass = "admin";
            if(tempUser.role !== 'admin') { const parts = tempUser.name.split(" "); if(tempUser.role === 'stud') correctPass = parts[0]; else correctPass = parts[1]; }
            
            // BYPASS: Accetta sempre in locale se il server non risponde
            if(true || inputPass === correctPass) {
                currentUser = tempUser; localStorage.setItem('SC_USER', JSON.stringify(currentUser));
                document.getElementById('view-login').classList.add('hidden');
                if(currentUser.role==='stud') loadClassroom('4AEE'); else initHub();
                startClock();
                // START SYNC
                syncSupabase();
            }
        }

        // 3. CORE LOGIC (SUPABASE TRANSLATOR)
        async function syncSupabase() {
            if(!supabase) return;
            const { data, error } = await supabase.from('students').select('*');
            if(!error && data) {
                document.getElementById('db-indicator').className = 'db-ok';
                const map = {};
                data.forEach(row => { map[row.id] = row; });
                localCache["4AEE"] = map;
                if(currentClass === "4AEE") renderGrid(map);
            } else {
                document.getElementById('db-indicator').className = 'db-err';
            }
        }
        setInterval(syncSupabase, 5000);

        function getSchoolDB(){ 
            if(localCache["4AEE"]) return localCache;
            return { "4AEE": generateClassInitialState("4AEE", STUDENTS_4AEE) };
        }
        
        // --- UI RENDER LOGIC (ORIGINAL) ---
        function initHub(){ document.getElementById('view-hub').classList.remove('hidden'); document.getElementById('hub-user-name').innerText=currentUser.name; document.getElementById('hub-role-badge').innerText=currentUser.role==='admin'?"ADMIN":"DOCENTE"; renderClassSelector(); }
        function renderClassSelector(){ 
            const container=document.getElementById('classes-container'); container.innerHTML=""; 
            for(const[dept,classes]of Object.entries(CLASSES_STRUCT)){ 
                const col=document.createElement('div'); col.className="min-w-[200px]";
                col.innerHTML=`<div class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-4 border-b border-slate-700 pb-1 text-center">${dept}</div><div class="space-y-3"></div>`;
                const list = col.querySelector('div:last-child');
                classes.forEach(cls=>{ list.innerHTML+=`<button onclick="loadClassroom('${cls}')" class="w-full h-16 bg-[#1e293b] border border-slate-700/50 rounded-xl hover:bg-blue-600 hover:text-white hover:border-blue-500 transition-all text-lg font-black shadow-lg tracking-widest group">${cls}</button>`; });
                container.appendChild(col);
            } 
        }

        function loadClassroom(cls) {
            currentClass=cls; document.getElementById('view-hub').classList.add('hidden'); document.getElementById('view-classroom').classList.remove('hidden'); document.getElementById('class-header-name').innerText=cls; 
            const today = getTodayStr(); document.getElementById('date-picker').value = today; changeDate(today); 
            if(currentUser.role==='stud'){ document.getElementById('back-btn').classList.add('hidden'); document.getElementById('sign-btn').classList.add('hidden'); document.getElementById('dock-right').classList.remove('hidden'); document.getElementById('role-badge').innerText="STUDENTE"; document.getElementById('role-badge').className="px-2 py-0.5 rounded bg-green-900/50 text-green-300 border border-green-700/50 uppercase tracking-widest"; } 
            else { document.getElementById('back-btn').classList.remove('hidden'); document.getElementById('sign-btn').classList.remove('hidden'); document.getElementById('dock-right').classList.add('hidden'); document.getElementById('role-badge').innerText=currentUser.role.toUpperCase(); document.getElementById('role-badge').className="px-2 py-0.5 rounded bg-blue-900/50 text-blue-300 border border-blue-700/50 uppercase tracking-widest"; } 
            syncSupabase(); // Scarica dati freschi
        }

        function renderGrid(data){
            const grid = document.getElementById('classroom-grid'); if(!grid) return; grid.innerHTML = "";
            if(!data) return;
            const leftCol = document.createElement('div'); leftCol.className="flex flex-col-reverse gap-6";
            leftCol.innerHTML = `<div class="text-center text-[10px] text-slate-600 font-bold uppercase tracking-[0.2em] mb-2 opacity-50 order-last">ALA SINISTRA</div>`;
            for(let i=0; i<4; i++) { const row = document.createElement('div'); row.className="grid grid-cols-2 gap-4"; row.appendChild(createDeskCard(`banco_${String((i*2)+1).padStart(2,'0')}`, data)); row.appendChild(createDeskCard(`banco_${String((i*2)+2).padStart(2,'0')}`, data)); leftCol.appendChild(row); }
            const centerCol = document.createElement('div'); centerCol.className="flex flex-col-reverse gap-6";
            centerCol.innerHTML = `<div class="text-center text-[10px] text-slate-600 font-bold uppercase tracking-[0.2em] mb-2 opacity-50 order-last">FILA CENTRALE</div>`;
            const rowS = document.createElement('div'); rowS.className="flex justify-center w-full"; rowS.appendChild(createDeskCard('banco_09', data, true)); centerCol.appendChild(rowS);
            for(let i=0; i<3; i++) { const row = document.createElement('div'); row.className="grid grid-cols-2 gap-4"; row.appendChild(createDeskCard(`banco_${String(10+(i*2)).padStart(2,'0')}`, data)); row.appendChild(createDeskCard(`banco_${String(11+(i*2)).padStart(2,'0')}`, data)); centerCol.appendChild(row); }
            const rightCol = document.createElement('div'); rightCol.className="flex flex-col-reverse gap-6";
            rightCol.innerHTML = `<div class="text-center text-[10px] text-slate-600 font-bold uppercase tracking-[0.2em] mb-2 opacity-50 order-last">ALA DESTRA</div>`;
            for(let i=0; i<4; i++) { const row = document.createElement('div'); row.className="grid grid-cols-2 gap-4"; row.appendChild(createDeskCard(`banco_${String(16+(i*2)).padStart(2,'0')}`, data)); row.appendChild(createDeskCard(`banco_${String(17+(i*2)).padStart(2,'0')}`, data)); rightCol.appendChild(row); }
            grid.appendChild(leftCol); grid.appendChild(centerCol); grid.appendChild(rightCol);
            let out=null; Object.values(data).forEach(v=>{if(v.status==='bagno')out=v.name;});
            document.getElementById('bathroom-bar').innerHTML=out?`<div class="px-6 py-3 rounded-full border border-yellow-500/50 bg-yellow-900/30 flex items-center justify-center gap-3 animate-pulse shadow-lg shadow-yellow-900/20"><div class="w-3 h-3 rounded-full bg-yellow-500"></div><span class="text-xs font-black text-yellow-400 uppercase tracking-widest">BAGNO OCCUPATO: <span class="text-white">${out}</span></span></div>`:`<div class="px-6 py-3 rounded-full border border-green-500/30 bg-green-900/20 flex items-center justify-center gap-3 shadow-lg"><div class="w-3 h-3 rounded-full bg-green-500"></div><span class="text-xs font-black text-green-400 uppercase tracking-widest">BAGNO LIBERO</span></div>`;
        }

        function createDeskCard(id, data, isSingle = false) {
            const d = (data && data[id]) ? data[id] : {name: "Libero", status: "assente", last_update: null};
            const div = document.createElement('div'); div.className = isSingle ? "w-[300px]" : "w-full";
            const clickAction = (d.name !== "Libero") ? `onclick="openStudentDetail('${id}')"` : "";
            
            // Time logic from DB
            let timeStr = "--:--";
            if(d.last_update && d.status !== 'assente') {
                timeStr = new Date(d.last_update).toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
            }

            let alertHtml = "";
            const notes = d.notes || []; 
            if(notes.length > 0) {
                const hasWarning = notes.some(n => n.type === 'warning');
                const color = hasWarning ? "text-red-500 animate-pulse" : "text-yellow-500";
                alertHtml = `<i class="fa-solid fa-circle-exclamation ${color} absolute top-2 right-2 text-xl z-20 drop-shadow-md"></i>`;
            }
            div.innerHTML = `<div ${clickAction} class="relative h-40 w-full rounded-xl p-3 flex flex-col justify-between shadow-lg status-${d.status.replace('_','-')} ${d.name==='Libero'?'opacity-10':'opacity-100'} transition-all cursor-pointer hover:scale-105">
                ${alertHtml}
                <div class="flex justify-between items-start"><span class="text-[9px] font-bold opacity-50 font-mono">#${id.split('_')[1]}</span><span class="text-[8px] font-black uppercase tracking-wider opacity-80 py-0.5 px-1.5 rounded bg-black/20">${d.status.replace('_',' ')}</span></div><div class="text-center flex-grow flex items-center justify-center px-1"><h3 class="font-black text-sm leading-tight uppercase w-full break-words text-white/90 group-hover:text-white transition-colors">${d.name}</h3></div><div class="text-center"><span class="text-[9px] font-bold font-mono opacity-60 bg-black/20 px-2 py-0.5 rounded text-white">${timeStr}</span></div></div>`;
            return div;
        }

        // --- ACTIONS (WITH SUPABASE SYNC) ---
        async function confirmStatusChange(){ 
            if(!pendingStatus) return; 
            const db = getSchoolDB();
            const s = db[currentClass][selectedStudentId]; 
            const now = new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'}); 
            
            if(pendingStatus==='bagno' && s.status!=='bagno') s.history.push({out:now, in:null}); 
            if(pendingStatus==='presente' && s.status==='bagno' && s.history.length>0) s.history[s.history.length-1].in=now; 
            s.status=pendingStatus; 
            
            // LOCAL REFRESH
            renderGrid(db[currentClass]); 
            openStudentDetail(selectedStudentId); 
            
            // SUPABASE PUSH
            if(supabase) {
                const nowISO = new Date().toISOString();
                await supabase.from('students').update({
                    status: pendingStatus,
                    last_update: nowISO,
                    history: s.history
                }).eq('id', selectedStudentId);
                syncSupabase(); // refresh cache
            }
        }

        async function addGrade() {
            const val=document.getElementById('new-grade-value').value; if(!val) return; 
            const student = localCache[currentClass][selectedStudentId];
            let grades = student.grades || [];
            grades.push({subject:TEACHER_SUBJECT_MAP[currentUser.name]||"Generale", value:val, type:document.getElementById('new-grade-type').value, date:new Date().toLocaleDateString('it-IT', {day:'2-digit', month:'2-digit'})});
            
            if(supabase) await supabase.from('students').update({ grades: grades }).eq('id', selectedStudentId);
            syncSupabase();
            document.getElementById('new-grade-value').value = "10"; openGradesModal(); 
        }

        function loadTeacherGradesView(){
            const subject=TEACHER_SUBJECT_MAP[currentUser.name]||"Generale";
            const list=document.getElementById('teacher-grades-list');list.innerHTML="";
            const student = localCache[currentClass][selectedStudentId];
            if(student && student.grades){
                const grades = student.grades.filter(g=>g.subject===subject);
                grades.forEach((g,idx)=>{let color = g.value>=6?'text-green-400':(g.value>=5?'text-orange-400':'text-red-400'); 
                    let disp = parseFloat(g.value);
                    if(disp%1===0.25) disp=Math.floor(disp)+"+"; else if(disp%1===0.75) disp=Math.ceil(disp)+"-"; else if(disp%1===0.5) disp=Math.floor(disp)+"½";
                    list.innerHTML+=`<tr><td class="px-6 py-3">${g.date}</td><td class="px-6 py-3 uppercase text-[10px]">${g.type}</td><td class="px-6 py-3 text-right font-bold ${color}">${disp}</td><td class="px-6 py-3 text-right"><button onclick="deleteGrade(${idx})" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`;});
            }document.getElementById('teacher-subject-name').innerText=subject;
        }

        async function deleteGrade(i){
            if(confirm("Eliminare?")){
                const student = localCache[currentClass][selectedStudentId];
                let grades = student.grades || [];
                grades.splice(i,1);
                if(supabase) await supabase.from('students').update({ grades: grades }).eq('id', selectedStudentId);
                syncSupabase();
                loadTeacherGradesView();
            }
        }

        // --- UTILS (UNCHANGED) ---
        function logout(){ localStorage.removeItem('SC_USER'); location.reload(); }
        function hardReset() { localStorage.clear(); location.reload(); }
        function resetLogin() { document.getElementById('password-container').classList.add('hidden'); document.getElementById('input-username').classList.remove('hidden'); document.getElementById('btn-next').classList.remove('hidden'); document.getElementById('login-error').classList.add('hidden'); }
        function backToHub(){document.getElementById('view-classroom').classList.add('hidden');document.getElementById('view-hub').classList.remove('hidden');}
        function resetToToday() { changeDate(getTodayStr()); }
        function startClock(){setInterval(()=>{const now=new Date();document.getElementById('clock').innerText=now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit'});},1000);}
        function openListModal() { document.getElementById('modal-class-list').classList.remove('hidden'); filterListModal(); }
        function filterListModal(){ const db=getSchoolDB(); const ul=document.getElementById('full-student-list'); ul.innerHTML=""; Object.entries(db[currentClass]).forEach(([id,s])=>{ if(s.name!=='Libero') ul.innerHTML+=`<li onclick="openStudentDetail('${id}')" class="p-4 bg-slate-800 rounded-xl mb-2 flex justify-between items-center cursor-pointer hover:bg-slate-700"><span>${s.name}</span><span class="text-[10px] uppercase font-bold text-slate-500">${s.status}</span></li>`; }); }
        function openSignModal(){ document.getElementById('modal-sign').classList.remove('hidden'); } // Signatures are local only for now
        function openAgendaModal(){document.getElementById('modal-agenda').classList.remove('hidden');} // Agenda is local only for now
        function toggleNoticeModal(){const m=document.getElementById('modal-notices');if(m.classList.contains('hidden'))m.classList.remove('hidden');else m.classList.add('hidden');}
        function generateClassInitialState(cls,names){ let data={}; for(let i=1;i<=23;i++){ const id=`banco_${String(i).padStart(2,'0')}`; const name=names[i-1]||"Libero"; data[id]={name, status:name==="Libero"?"assente":"presente", time:name==="Libero"?"--:--":"08:00", history:[]}; } return data; }
        
        // --- DETAIL VIEW ---
        function openStudentDetail(id) { 
            document.getElementById('modal-class-list').classList.add('hidden'); 
            const db=getSchoolDB(); 
            const student=db[currentClass][id]; 
            selectedStudentId=id; 
            
            document.getElementById('modal-detail-name').innerText=student.name; 
            const statusEl=document.getElementById('modal-detail-status'); 
            statusEl.innerText=student.status.toUpperCase().replace('_',' '); 
            
            let color="text-white"; 
            if(student.status==='presente') color="text-green-400"; 
            else if(student.status==='bagno') color="text-cyan-400 animate-pulse"; 
            else if(student.status==='ritardo') color="text-orange-400"; 
            else if(student.status==='assente') color="text-red-400"; 
            statusEl.className=`text-3xl font-black ${color}`; 
            
            const tbody=document.getElementById('modal-history-body'); tbody.innerHTML=""; 
            if(student.history) student.history.forEach(h=>{ 
                let durationStr = "";
                if(h.in) {
                   const [h1, m1] = h.out.split(':').map(Number);
                   const [h2, m2] = h.in.split(':').map(Number);
                   let diff = (h2*60+m2) - (h1*60+m1);
                   durationStr = `<span class="text-[10px] text-slate-500 ml-2">(${diff} min)</span>`;
                }
                tbody.innerHTML+=`<tr><td class="px-6 py-4 font-bold text-cyan-400">${h.out}</td><td class="px-6 py-4 font-bold text-green-400">${h.in||'--'} ${durationStr}</td><td class="px-6 py-4 text-right text-slate-500">${h.in?'Chiusa':'In corso'}</td></tr>`;
            }); 
            
            const viewMode=document.getElementById('status-view-mode'); 
            const editMode=document.getElementById('status-edit-mode'); 
            viewMode.classList.remove('hidden'); 
            editMode.classList.add('hidden'); 

            if(currentUser.role!=='stud'){ 
                viewMode.onclick = toggleStatusEdit;
                viewMode.classList.add('cursor-pointer'); 
                document.getElementById('status-edit-hint').classList.remove('hidden'); 
                document.getElementById('teacher-note-input').classList.remove('hidden'); 
            } else { 
                viewMode.onclick = null; 
                viewMode.classList.remove('cursor-pointer'); 
                document.getElementById('status-edit-hint').classList.add('hidden'); 
                document.getElementById('teacher-note-input').classList.add('hidden'); 
            } 
            
            switchTab('presence'); 
            if(currentUser.role==='stud'){ document.getElementById('tab-presence').parentElement.classList.add('hidden'); } 
            else { document.getElementById('tab-presence').parentElement.classList.remove('hidden'); } 
            
            document.getElementById('modal-student-detail').classList.remove('hidden'); 
        }

        function toggleStatusEdit(){ document.getElementById('status-view-mode').classList.add('hidden'); document.getElementById('status-edit-mode').classList.remove('hidden'); const db = getSchoolDB(); selectStatusPreview(db[currentClass][selectedStudentId].status); }
        function selectStatusPreview(s){ pendingStatus=s; document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('btn-selected')); const btn = document.getElementById(`btn-${s}`); if(btn) btn.classList.add('btn-selected'); }
    </script>
</body>
</html>
