<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartCheck - School OS v75</title>
    <meta name="theme-color" content="#050b14">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050b14; -webkit-tap-highlight-color: transparent; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: rgba(20, 27, 45, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .hidden { display: none !important; }
        input[type="date"] { color-scheme: dark; }
        
        /* Debug Console Style */
        #debug-console {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.9); color: #00ff00;
            font-family: monospace; font-size: 10px;
            height: 100px; overflow-y: auto; padding: 10px;
            z-index: 9999; border-top: 1px solid #333;
        }

        /* COLORS */
        .status-bagno { border: 1px solid #06b6d4 !important; background: linear-gradient(145deg, rgba(8, 51, 68, 0.9), rgba(22, 78, 99, 0.4)) !important; color: #67e8f9 !important; animation: pulse 2s infinite; }
        .status-presente { border: 1px solid #22c55e !important; background: linear-gradient(145deg, rgba(20, 83, 45, 0.5), rgba(5, 46, 22, 0.7)) !important; color: #4ade80 !important; }
        .status-assente { border: 1px solid #ef4444 !important; background: rgba(127, 29, 29, 0.2) !important; color: #ef4444 !important; opacity: 0.6; }
        .status-ritardo { border: 1px solid #f97316 !important; background: linear-gradient(145deg, rgba(67, 20, 7, 0.6), rgba(124, 45, 18, 0.2)) !important; color: #fdba74 !important; }
        .status-seconda-ora { border: 1px solid #8b5cf6 !important; background: linear-gradient(145deg, rgba(76, 29, 149, 0.6), rgba(109, 40, 217, 0.2)) !important; color: #c4b5fd !important; }
        .status-uscita-anticipata { border: 1px solid #eab308 !important; background: linear-gradient(145deg, rgba(66, 32, 6, 0.6), rgba(113, 63, 18, 0.2)) !important; color: #fde047 !important; }
        
        .btn-selected { transform: scale(1.05); border: 2px solid white !important; }
        .grade-circle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: white; position: relative; }
        .grade-circle::before { content: ''; position: absolute; inset: 6px; background: #111; border-radius: 50%; }
        .grade-value { position: relative; z-index: 10; font-size: 14px; }
        .g-green { background: conic-gradient(#22c55e var(--percent), #333 0); } .text-g-green { color: #4ade80; } 
        .g-orange { background: conic-gradient(#f97316 var(--percent), #333 0); } .text-g-orange { color: #fb923c; } 
        .g-red { background: conic-gradient(#ef4444 var(--percent), #333 0); } .text-g-red { color: #f87171; } 
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col overflow-x-hidden bg-[#050b14]">

    <div id="debug-console">Log di Sistema v75.0...</div>

    <div id="view-login" class="fixed inset-0 z-[100] bg-[#050b14] flex items-center justify-center p-4">
        <div class="relative z-10 w-full max-w-5xl h-[600px] glass-panel rounded-3xl overflow-hidden flex shadow-2xl">
            <div class="w-1/2 bg-gradient-to-br from-blue-600/20 to-purple-900/40 p-12 flex flex-col justify-between relative border-r border-white/5">
                <div>
                    <h1 class="text-6xl font-black italic text-white tracking-tighter mb-4"><span class="text-blue-500">SMART</span><br>CHECK.</h1>
                    <div class="w-20 h-1 bg-blue-500 rounded-full mb-6"></div>
                    <p class="text-slate-300 font-light text-lg">Il sistema operativo scolastico<br>di nuova generazione.</p>
                </div>
                <div class="text-xs font-mono text-slate-500">v75.0 • Emergency Mode</div>
            </div>
            <div class="w-1/2 p-12 flex flex-col justify-center items-center bg-[#0a0f1c]/80">
                <div class="w-full max-w-xs space-y-8">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-white mb-1">Accesso</h2>
                        <p class="text-slate-400 text-sm">Inserisci le tue credenziali</p>
                    </div>
                    <div id="login-form" class="space-y-5">
                        <input type="text" id="input-username" placeholder="cognome.nome" class="w-full bg-[#131b2e] border border-slate-700 text-white px-5 py-4 rounded-xl focus:border-blue-500 outline-none text-center font-bold lowercase transition-all">
                        
                        <div id="password-container" class="hidden space-y-5">
                            <p class="text-center text-sm font-bold text-blue-400 uppercase tracking-widest" id="user-welcome">--</p>
                            <input type="password" id="input-password" placeholder="Password" class="w-full bg-[#131b2e] border border-slate-700 text-white px-5 py-4 rounded-xl focus:border-blue-500 outline-none text-center">
                            
                            <button onclick="attemptLogin()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg transform hover:scale-[1.02]">ENTRA</button>
                            <button onclick="resetLogin()" class="w-full text-xs text-slate-500 hover:text-white underline">Indietro</button>
                        </div>

                        <button id="btn-next" onclick="checkUsername()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">CONTINUA <i class="fa-solid fa-arrow-right ml-2"></i></button>
                    </div>
                    <p id="login-error" class="text-red-400 text-xs font-bold text-center hidden bg-red-900/20 p-2 rounded border border-red-900/50"><i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="error-text">Credenziali Errate</span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="view-hub" class="hidden min-h-screen p-8 fade-in">
        <header class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
            <div><h2 class="text-3xl font-black text-white italic">HUB <span class="text-blue-500">ISTITUTO</span></h2><div class="flex gap-2 mt-1"><span id="hub-role-badge" class="text-[10px] font-bold px-2 py-0.5 rounded border border-slate-700 uppercase tracking-widest text-slate-400">--</span><span id="hub-user-name" class="text-sm text-slate-300 font-bold">--</span></div></div>
            <button onclick="logout()" class="px-5 py-2 bg-red-900/20 border border-red-500/30 rounded-xl text-red-400 hover:bg-red-500 hover:text-white transition-all text-xs font-black">ESCI</button>
        </header>
        <div class="glass-panel p-10 rounded-3xl border border-slate-700/50 flex justify-center">
            <div class="flex justify-center gap-16 overflow-x-auto pb-4 custom-scrollbar w-full max-w-6xl" id="classes-container"></div>
        </div>
    </div>

    <div id="view-classroom" class="hidden min-h-screen flex flex-col relative fade-in">
        <header class="bg-[#0b1121]/90 backdrop-blur-md border-b border-slate-800 px-8 py-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center gap-6">
                <button id="back-btn" onclick="backToHub()" class="p-2.5 bg-slate-800 rounded-xl hover:bg-slate-700 text-slate-400 transition-all"><i class="fa-solid fa-arrow-left"></i></button>
                <div><h1 class="text-2xl font-black text-white italic tracking-tight"><span class="text-blue-500">CLASSE</span> <span id="class-header-name">4AEE</span></h1><div id="sync-status" class="flex items-center gap-2 text-[10px] font-mono text-green-400 mt-1"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> ONLINE</div></div>
            </div>
            <div class="relative group mx-4"><div class="glass-panel px-5 py-2.5 rounded-xl flex items-center gap-3 cursor-pointer border border-slate-700 hover:border-blue-500 transition-all" onclick="resetToToday()"><i class="fa-regular fa-calendar text-blue-400 text-lg"></i><div class="flex flex-col text-right"><span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest leading-none mb-1">DATA</span><span id="date-display" class="font-mono text-sm font-bold text-white leading-none uppercase">Oggi</span></div><input type="date" id="date-picker" class="absolute inset-0 opacity-0 cursor-pointer" onchange="changeDate(this.value)"></div></div>
            <div class="flex items-center gap-3"><button onclick="openListModal()" class="px-5 py-2.5 bg-slate-800 border border-slate-600 rounded-xl text-xs font-bold text-slate-300 hover:bg-slate-700 uppercase tracking-wider transition-all"><i class="fa-solid fa-list-ul mr-2"></i>ELENCO</button><button id="sign-btn" onclick="openSignModal()" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-bold uppercase tracking-wider shadow-lg transition-all"><i class="fa-solid fa-book-open mr-2"></i>REGISTRO</button><button onclick="logout()" class="px-3 py-2.5 bg-red-900/10 text-red-400 border border-red-900/30 rounded-xl text-xs font-bold hover:bg-red-900/30 transition-all ml-2">ESCI</button><div class="text-right border-l border-slate-700 pl-6 ml-2"><div id="clock" class="mono text-2xl font-bold text-slate-200">00:00:00</div><div id="hour-badge" class="text-[10px] text-purple-400 font-bold uppercase tracking-widest text-right leading-none">--</div></div></div>
        </header>
        <main class="flex-grow flex flex-col items-center w-full px-4 pb-40 pt-8">
            <div id="loading-grid" class="hidden py-32 text-center"><div class="loader mb-4"></div><p class="text-slate-500 text-xs font-mono uppercase tracking-widest">Sincronizzazione Cloud...</p></div>
            <div id="bathroom-bar" class="w-full max-w-2xl mb-6 flex justify-center"></div>
            <div class="grid grid-cols-3 gap-24 w-full max-w-[95%]" id="classroom-grid"></div>
            <div onclick="openSignModal()" class="mt-24 w-[450px] h-24 bg-[#1e293b]/90 backdrop-blur border-b-4 border-blue-500 rounded-3xl flex flex-col items-center justify-center shadow-2xl px-4 cursor-pointer hover:scale-105 transition-transform group"><span class="text-2xl font-black tracking-[0.4em] text-blue-400 uppercase">Cattedra</span><span id="signature-display" class="text-xs text-slate-400 font-mono mt-2 w-full text-center truncate group-hover:text-blue-300">Clicca per Registro</span></div>
            <button onclick="openAdminPairing()" class="mt-12 opacity-20 hover:opacity-100 text-[10px] text-slate-500 font-mono border border-slate-700 px-4 py-2 rounded-full transition-opacity">⚙️ Gestione Badge RFID</button>
        </main>
        <div class="fixed bottom-8 left-8 z-50 flex gap-6"><div onclick="openAgendaModal()" class="tool-btn tool-agenda group"><i class="fa-solid fa-calendar-check text-pink-500 group-hover:text-pink-400 text-2xl mb-1"></i><span class="text-slate-400 group-hover:text-white">AGENDA</span></div><div onclick="toggleNoticeModal()" class="tool-btn tool-bacheca group"><i class="fa-solid fa-bullhorn text-yellow-500 group-hover:text-yellow-400 text-2xl mb-1"></i><span class="text-slate-400 group-hover:text-white">AVVISI</span></div></div>
        <div id="dock-right" class="fixed bottom-8 right-8 z-50 hidden"><div onclick="openGradesModal()" class="tool-btn tool-voti group"><i class="fa-solid fa-chart-pie text-[#66cc00] group-hover:text-green-400 text-2xl mb-1"></i><span class="text-slate-400 group-hover:text-white">VOTI</span></div></div>
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[45%] max-w-3xl glass-panel px-8 py-4 rounded-full flex flex-wrap justify-between items-center shadow-2xl z-40 border border-slate-700/50 backdrop-blur-xl">
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-green-500"></span> Presente</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-cyan-400 animate-pulse"></span> Bagno</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-violet-500"></span> 2° Ora</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span> Uscita</div>
            <div class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-400"><span class="w-2.5 h-2.5 rounded-full border border-red-500 bg-red-900/20"></span> Assente</div>
        </div>
    </div>

    <div id="modal-class-list" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm"><div class="glass-panel w-full max-w-2xl h-[80vh] p-8 rounded-3xl shadow-2xl flex flex-col border border-slate-700"><div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-700"><h2 class="text-2xl font-black text-white italic uppercase tracking-tighter">ELENCO <span id="list-class-name" class="text-blue-500"></span></h2><button onclick="document.getElementById('modal-class-list').classList.add('hidden')" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-lg">✕</button></div><input type="text" id="list-search" placeholder="Cerca studente..." onkeyup="filterListModal()" class="w-full bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl focus:border-blue-500 outline-none mb-4"><div class="overflow-y-auto flex-grow custom-scrollbar"><ul id="full-student-list" class="space-y-2"></ul></div></div></div>
    <div id="modal-student-detail" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/90 backdrop-blur-sm"><div class="bg-[#0f172a] w-full max-w-3xl rounded-3xl p-8 border border-slate-700 shadow-2xl relative"><div class="flex justify-between items-start mb-6"><div><h2 id="modal-detail-name" class="text-4xl font-black text-white tracking-tight">Nome Cognome</h2><div class="flex gap-4 mt-4 text-xs font-bold uppercase tracking-widest"><button onclick="switchTab('presence')" id="tab-presence" class="text-blue-400 border-b-2 border-blue-400 pb-1">Presenze</button></div></div><button onclick="document.getElementById('modal-student-detail').classList.add('hidden')" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white">✕</button></div><div id="content-presence"><div class="grid grid-cols-2 gap-6 mb-8"><div id="status-card" class="bg-[#1e293b]/50 p-6 rounded-2xl border border-slate-700 group transition-all"><div class="text-[10px] text-slate-400 font-bold uppercase mb-2">Stato Attuale</div><div id="status-view-mode" class="cursor-pointer"><div id="modal-detail-status" class="text-3xl font-black text-white">--</div><div id="status-edit-hint" class="hidden text-[10px] text-blue-400 mt-2 font-mono items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen"></i> CLICCA PER MODIFICARE</div></div><div id="status-edit-mode" class="hidden"><div class="grid grid-cols-2 gap-2 mt-1"><button onclick="selectStatusPreview('presente')" id="btn-presente" class="status-btn py-2 text-xs font-bold bg-green-900/40 text-green-400 border border-green-600/50 rounded">PRESENTE</button><button onclick="selectStatusPreview('bagno')" id="btn-bagno" class="status-btn py-2 text-xs font-bold bg-cyan-900/40 text-cyan-400 border border-cyan-600/50 rounded">BAGNO</button><button onclick="selectStatusPreview('ritardo')" id="btn-ritardo" class="status-btn py-2 text-xs font-bold bg-orange-900/40 text-orange-400 border border-orange-600/50 rounded">RITARDO</button><button onclick="selectStatusPreview('seconda_ora')" id="btn-seconda_ora" class="status-btn py-2 text-xs font-bold bg-violet-900/40 text-violet-400 border border-violet-600/50 rounded">2° ORA</button><button onclick="selectStatusPreview('uscita_anticipata')" id="btn-uscita_anticipata" class="status-btn py-2 text-xs font-bold bg-yellow-900/40 text-yellow-400 border border-yellow-600/50 rounded">USCITA</button><button onclick="selectStatusPreview('assente')" id="btn-assente" class="status-btn py-2 text-xs font-bold bg-red-900/40 text-red-400 border border-red-600/50 rounded">ASSENTE</button></div><div class="flex gap-2 mt-3"><button onclick="confirmStatusChange()" class="flex-grow py-3 bg-blue-600 text-white font-bold text-xs rounded-lg uppercase tracking-wider shadow-lg">APPLICA</button><button onclick="toggleStatusEdit()" class="px-4 py-3 bg-slate-700 text-slate-300 font-bold text-xs rounded-lg">✕</button></div></div></div><div class="bg-[#1e293b]/50 p-6 rounded-2xl border border-slate-700 flex flex-col justify-center"><div class="text-[10px] text-slate-400 font-bold uppercase mb-2">Uscite</div><div id="modal-detail-count" class="text-4xl font-black text-white">0</div></div></div><div class="bg-[#1e293b] rounded-xl overflow-hidden border border-slate-700/50"><table class="w-full text-left text-sm font-mono text-slate-300"><thead class="bg-slate-800 text-[10px] uppercase font-bold text-slate-400"><tr><th class="px-6 py-3">Uscita</th><th class="px-6 py-3">Rientro</th><th class="px-6 py-3 text-right">Stato</th></tr></thead><tbody id="modal-history-body" class="divide-y divide-slate-800"></tbody></table></div></div></div>
    
    <script>
        // --- LOGGER (VISUALIZZA COSA SUCCEDE) ---
        function debug(msg) {
            const el = document.getElementById('debug-console');
            const now = new Date().toLocaleTimeString();
            el.innerHTML += `<div>[${now}] ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://axlfuzksfpfwdvjawlmf.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4bGZ1emtzZnBmd2R2amF3bG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MzYyMzYsImV4cCI6MjA4NDUxMjIzNn0.Xga9UIWfS8rYxGYZs-Cz446GZkVhPCxeUvV8UUTlXEg';
        let supabase = null;

        // --- AVVIO IMMEDIATO ---
        window.onload = function() {
            alert("SISTEMA AVVIATO: Se vedi questo messaggio, il JS funziona!");
            debug("Sistema avviato.");
            
            try {
                supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                debug("Supabase client creato.");
            } catch(e) {
                debug("Errore Supabase Critico: " + e.message);
                alert("Errore caricamento Supabase!");
            }

            // GESTIONE TASTI INVIO (BLINDATA)
            document.getElementById('input-username').addEventListener('keydown', function(e) {
                if(e.key === 'Enter') checkUsername();
            });
            document.getElementById('input-password').addEventListener('keydown', function(e) {
                if(e.key === 'Enter') attemptLogin();
            });
        };

        const TEACHER_MAP = {
            "piccirilli.stefania": ["Italiano", "Storia"],
            "admin": [],
            "navarroli.antonio": []
        };
        const CLASSES_STRUCT={ "ELETTRONICA":["1AEE","2AEE","3AEE","4AEE","5AEE"], "MECCANICA":["1AMM","2AMM","3AMM","4AMM","5AMM","4 MAUT","4 MROB","5 MA/R", "1 MA/R", "2 MA/R", "3 MA/R"], "CHIMICA":["1ACM","2ACM","3ACM","4ACM","5ACM"] };
        let currentUser = null;
        let localStudentsData = [];
        let selectedId = null;
        let pendingStatus = null;

        // --- FUNZIONE LOGIN SEMPLIFICATA ---
        function checkUsername() {
            debug("Pulsante Continua Premuto");
            const input = document.getElementById('input-username').value.trim().toLowerCase();
            if (!input) return debug("Username vuoto");

            let role = 'stud';
            let name = input;

            if (input === 'admin') {
                role = 'admin';
                name = 'Amministratore';
            } else if (input.includes('.')) {
                role = 'prof'; // Semplificazione totale: se ha il punto, è prof o studente specifico
            }

            currentUser = { u: input, role: role, name: name };
            debug("Utente rilevato: " + role);

            // CAMBIO SCHERMATA MANUALE
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('password-container').classList.remove('hidden');
            document.getElementById('user-welcome').innerText = name;
            
            setTimeout(() => document.getElementById('input-password').focus(), 100);
        }

        function attemptLogin() {
            debug("Tentativo Accesso...");
            localStorage.setItem('SC_USER', JSON.stringify(currentUser));
            debug("Salvataggio localStorage ok.");
            
            // CARICAMENTO APP
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-classroom').classList.remove('hidden');
            
            if (currentUser.role === 'stud') {
                document.getElementById('back-btn').classList.add('hidden');
                document.getElementById('sign-btn').classList.add('hidden');
                document.getElementById('dock-right').classList.remove('hidden');
            } else {
                document.getElementById('role-badge').innerText = "DOCENTE";
            }
            
            initRealtime();
            renderClassSelector();
        }

        function renderClassSelector(){ 
            const container=document.getElementById('classes-container'); container.innerHTML=""; 
            for(const[dept,classes]of Object.entries(CLASSES_STRUCT)){ 
                const col=document.createElement('div'); col.className="min-w-[200px]";
                col.innerHTML=`<div class="text-xs text-slate-500 font-bold uppercase tracking-widest mb-4 border-b border-slate-700 pb-1 text-center">${dept}</div><div class="space-y-3"></div>`;
                const list = col.querySelector('div:last-child');
                classes.forEach(cls=>{ list.innerHTML+=`<button onclick="loadClassroom('${cls}')" class="w-full h-16 bg-[#1e293b] border border-slate-700/50 rounded-xl hover:bg-blue-600 hover:text-white hover:border-blue-500 transition-all text-lg font-black shadow-lg tracking-widest group">${cls}</button>`; });
                container.appendChild(col);
            } 
        }

        async function initRealtime() {
            debug("Download dati...");
            const { data, error } = await supabase.from('students').select('*').order('id', { ascending: true });
            
            if (error) {
                debug("ERRORE DB: " + error.message);
                alert("Errore DB: " + error.message);
            } else {
                debug("Dati scaricati: " + data.length + " studenti.");
                localStudentsData = data;
                renderGrid(data);
                document.getElementById('loading-grid').classList.add('hidden');
            }

            supabase.channel('public:students').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'students' }, payload => {
                const index = localStudentsData.findIndex(s => s.id === payload.new.id);
                if(index !== -1) {
                    localStudentsData[index] = payload.new;
                    renderGrid(localStudentsData);
                    if(selectedId === payload.new.id) refreshStudentDetail(payload.new);
                }
            }).subscribe();
        }

        function renderGrid(data){
            const grid = document.getElementById('classroom-grid'); grid.innerHTML = "";
            const leftData = data.slice(0, 8); const centerData = data.slice(8, 15); const rightData = data.slice(15, 23); 
            const createCol = (items) => {
                const col = document.createElement('div'); col.className="flex flex-col-reverse gap-6";
                for(let i=0; i<items.length; i+=2) {
                    const row = document.createElement('div'); row.className="grid grid-cols-2 gap-4";
                    if(items[i]) row.appendChild(createCard(items[i]));
                    if(items[i+1]) row.appendChild(createCard(items[i+1]));
                    col.appendChild(row);
                } return col;
            };
            const createCenterCol = (items) => {
                const col = document.createElement('div'); col.className="flex flex-col-reverse gap-6";
                if(items.length > 0) { const singleRow = document.createElement('div'); singleRow.className="flex justify-center w-full"; singleRow.appendChild(createCard(items[0], true)); col.appendChild(singleRow); }
                for(let i=1; i<items.length; i+=2) { const row = document.createElement('div'); row.className="grid grid-cols-2 gap-4"; if(items[i]) row.appendChild(createCard(items[i])); if(items[i+1]) row.appendChild(createCard(items[i+1])); col.appendChild(row); } return col;
            }
            const col1 = document.createElement('div'); col1.innerHTML = `<div class="text-center text-[10px] text-slate-600 font-bold uppercase tracking-[0.2em] mb-4 opacity-50">ALA SINISTRA</div>`; col1.appendChild(createCol(leftData));
            const col2 = document.createElement('div'); col2.innerHTML = `<div class="text-center text-[10px] text-slate-600 font-bold uppercase tracking-[0.2em] mb-4 opacity-50">FILA CENTRALE</div>`; col2.appendChild(createCenterCol(centerData));
            const col3 = document.createElement('div'); col3.innerHTML = `<div class="text-center text-[10px] text-slate-600 font-bold uppercase tracking-[0.2em] mb-4 opacity-50">ALA DESTRA</div>`; col3.appendChild(createCol(rightData));
            grid.appendChild(col1); grid.appendChild(col2); grid.appendChild(col3);
            let whoInBath = data.find(s => s.status === 'bagno');
            document.getElementById('bathroom-bar').innerHTML = whoInBath ? `<div class="px-6 py-3 rounded-full border border-yellow-500/50 bg-yellow-900/30 flex items-center justify-center gap-3 animate-pulse shadow-lg"><div class="w-3 h-3 rounded-full bg-yellow-500"></div><span class="text-xs font-black text-yellow-400 uppercase tracking-widest">BAGNO OCCUPATO: <span class="text-white">${whoInBath.name}</span></span></div>` : `<div class="px-6 py-3 rounded-full border border-green-500/30 bg-green-900/20 flex items-center justify-center gap-3 shadow-lg"><div class="w-3 h-3 rounded-full bg-green-500"></div><span class="text-xs font-black text-green-400 uppercase tracking-widest">BAGNO LIBERO</span></div>`;
        }

        function createCard(student, isSingle=false) {
            const div = document.createElement('div'); div.className = isSingle ? "w-[300px]" : "w-full";
            let timeStr = "--:--";
            if(student.last_update && student.status !== 'assente') {
                timeStr = new Date(student.last_update).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
            }
            div.innerHTML = `<div onclick="openStudentDetail('${student.id}')" class="relative h-40 w-full rounded-xl p-3 flex flex-col justify-between shadow-lg status-${student.status ? student.status.replace('_','-') : 'assente'} cursor-pointer hover:scale-105 transition-all"><div class="flex justify-between items-start"><span class="text-[9px] font-bold opacity-50 font-mono">#${student.id.split('_')[1]}</span><span class="text-[8px] font-black uppercase tracking-wider opacity-80 py-0.5 px-1.5 rounded bg-black/20">${student.status || 'ND'}</span></div><div class="text-center flex-grow flex items-center justify-center px-1"><h3 class="font-black text-sm leading-tight uppercase w-full break-words text-white/90">${student.name}</h3></div><div class="text-center"><span class="text-[9px] font-bold font-mono opacity-60 bg-black/20 px-2 py-0.5 rounded text-white">${timeStr}</span></div></div>`;
            return div;
        }

        // --- UTILS ---
        function resetLogin() { document.getElementById('password-container').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); }
        function hardReset() { localStorage.clear(); location.reload(); }
        function logout(){ localStorage.clear(); location.reload(); }
        
        function openStudentDetail(id) {
            selectedId = id;
            const student = localStudentsData.find(x => x.id === id);
            refreshStudentDetail(student);
            document.getElementById('modal-student-detail').classList.remove('hidden');
            const viewMode = document.getElementById('status-view-mode');
            const editMode = document.getElementById('status-edit-mode');
            viewMode.classList.remove('hidden'); editMode.classList.add('hidden');
            
            if(currentUser.role !== 'stud'){
                viewMode.onclick = toggleStatusEdit; viewMode.classList.add('cursor-pointer');
                document.getElementById('status-edit-hint').classList.remove('hidden');
            } else {
                viewMode.onclick = null; viewMode.classList.remove('cursor-pointer');
                document.getElementById('status-edit-hint').classList.add('hidden');
            }
            switchTab('presence');
        }

        function refreshStudentDetail(student) {
            document.getElementById('modal-detail-name').innerText = student.name;
            const statusEl = document.getElementById('modal-detail-status');
            statusEl.innerText = student.status.toUpperCase().replace('_',' ');
            let color="text-white"; 
            if(student.status==='presente')color="text-green-400";
            else if(student.status==='bagno')color="text-cyan-400 animate-pulse";
            else if(student.status==='ritardo')color="text-orange-400";
            else if(student.status==='assente')color="text-red-400";
            statusEl.className=`text-3xl font-black ${color}`;
            const tbody = document.getElementById('modal-history-body'); tbody.innerHTML = "";
            (student.history || []).forEach(h => {
                let durationStr = "";
                if(h.in && h.out) {
                   const [h1, m1] = h.out.split(':').map(Number);
                   const [h2, m2] = h.in.split(':').map(Number);
                   let diff = (h2*60+m2) - (h1*60+m1);
                   durationStr = `<span class="text-[10px] text-slate-500 ml-2">(${diff} min)</span>`;
                }
                tbody.innerHTML += `<tr><td class="px-6 py-4 font-bold text-cyan-400">${h.out}</td><td class="px-6 py-4 font-bold text-green-400">${h.in||'--'} ${durationStr}</td><td class="px-6 py-4 text-right text-slate-500">${h.in?'Chiusa':'In corso'}</td></tr>`;
            });
        }

        function toggleStatusEdit(){ document.getElementById('status-view-mode').classList.add('hidden'); document.getElementById('status-edit-mode').classList.remove('hidden'); const s = localStudentsData.find(x => x.id === selectedId); selectStatusPreview(s.status); }
        function selectStatusPreview(s){ pendingStatus=s; document.querySelectorAll('.status-btn').forEach(b=>b.classList.remove('btn-selected')); const btn = document.getElementById(`btn-${s}`); if(btn) btn.classList.add('btn-selected'); }
        async function confirmStatusChange(){
            if(!selectedId || !pendingStatus) return;
            const student = localStudentsData.find(x => x.id === selectedId);
            let newHistory = student.history ? [...student.history] : [];
            const now = new Date().toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
            
            const nowISO = new Date().toISOString(); 

            if(pendingStatus==='bagno' && student.status!=='bagno') newHistory.push({out:now, in:null});
            if(pendingStatus==='presente' && student.status==='bagno' && newHistory.length>0) newHistory[newHistory.length-1].in=now;
            
            const { error } = await supabase.from('students').update({ status: pendingStatus, last_update: nowISO, history: newHistory }).eq('id', selectedId);
            if(!error) toggleStatusEdit();
        }

        function openAdminPairing() { document.getElementById('modal-admin-pairing').classList.remove('hidden'); const sel = document.getElementById('pairing-student-select'); sel.innerHTML = ""; localStudentsData.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`); }
        async function savePairing() { const id = document.getElementById('pairing-student-select').value; const uid = document.getElementById('pairing-uid').value.toUpperCase().replace(/\s/g, ''); if(!uid) return; const { error } = await supabase.from('rfid_tags').insert({ uid: uid, student_id: id }); if(error) alert(error.message); else { alert("Associato!"); document.getElementById('pairing-uid').value = ""; } }
        function switchTab(t){ document.getElementById('content-presence').classList.toggle('hidden',t!=='presence'); }
    </script>
</body>
</html>