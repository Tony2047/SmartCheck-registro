<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCheck Dashboard - 4AEE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        input[type="date"]::-webkit-calendar-picker-indicator { position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4); border-color: rgba(6, 182, 212, 0.6); } 70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); border-color: rgba(6, 182, 212, 1); } 100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); border-color: rgba(6, 182, 212, 0.6); } }
        .status-bagno { animation: pulse-blue 2s infinite; background: linear-gradient(145deg, rgba(8, 51, 68, 0.8), rgba(22, 78, 99, 0.3)) !important; border: 1px solid #06b6d4 !important; color: #67e8f9 !important; }
        .status-ritardo { border: 1px solid #f97316 !important; background: linear-gradient(145deg, rgba(67, 20, 7, 0.6), rgba(124, 45, 18, 0.2)) !important; box-shadow: 0 0 15px rgba(249, 115, 22, 0.2); color: #fdba74 !important; }
        .status-seconda-ora { border: 1px solid #8b5cf6 !important; background: linear-gradient(145deg, rgba(76, 29, 149, 0.6), rgba(109, 40, 217, 0.2)) !important; box-shadow: 0 0 15px rgba(139, 92, 246, 0.2); color: #c4b5fd !important; }
        .status-uscita { border: 1px solid #eab308 !important; background: linear-gradient(145deg, rgba(66, 32, 6, 0.6), rgba(113, 63, 18, 0.2)) !important; color: #fde047 !important; opacity: 0.8; }
        .status-presente { border: 1px solid #22c55e !important; background: linear-gradient(145deg, rgba(20, 83, 45, 0.4), rgba(5, 46, 22, 0.6)) !important; box-shadow: 0 0 15px rgba(34, 197, 94, 0.1); color: #4ade80 !important; }
        .status-assente { border: 1px solid #ef4444 !important; background: rgba(127, 29, 29, 0.1) !important; color: #ef4444 !important; opacity: 0.4; }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-overlay { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="bg-[#0b1121] text-slate-200 min-h-screen p-6 flex flex-col overflow-x-hidden">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-[#0b1121] flex flex-col items-center justify-center transition-all duration-700">
        <div class="glass-panel p-12 rounded-3xl shadow-2xl border border-slate-700 text-center max-w-md w-full mx-4">
            <div class="mb-8">
                <h1 class="text-5xl font-black italic tracking-tighter text-white mb-2">
                    <span class="text-blue-500">SMART</span>CHECK
                </h1>
                <p class="text-slate-400 text-xs uppercase tracking-[0.4em] font-bold">Portale Accesso Remoto</p>
            </div>
            
            <div class="flex flex-col gap-6">
                <div class="relative">
                    <input type="password" id="pin-input" placeholder="PIN CLASSE" maxlength="4"
                        class="w-full bg-slate-900/50 border-2 border-slate-700 text-white text-center text-3xl font-mono py-4 rounded-xl focus:outline-none focus:border-blue-500 transition-all placeholder:text-slate-700 placeholder:text-xl tracking-[0.5em]">
                </div>
                
                <button onclick="attemptLogin()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-4 rounded-xl uppercase tracking-widest transition-all shadow-lg shadow-blue-900/50 transform active:scale-95">
                    Entra
                </button>
                
                <p id="login-error" class="text-red-500 text-xs font-bold uppercase tracking-widest hidden animate-pulse">
                    ⚠️ Accesso Negato: PIN Errato
                </p>
            </div>
            
            <div class="mt-8 pt-6 border-t border-slate-700/50">
                <p class="text-[10px] text-slate-500 font-mono">ID Sessione: <span class="text-blue-500">SECURE_4AEE_V12</span></p>
            </div>
        </div>
    </div>

    <header class="w-full flex justify-between items-center mb-4 pb-4 border-b border-slate-800/60 px-8 sticky top-0 bg-[#0b1121]/90 backdrop-blur z-30">
        <div>
            <h1 class="text-4xl font-black tracking-tighter text-white italic">
                <span class="text-blue-500">SMART</span>CHECK <span class="text-sm not-italic bg-blue-600/20 text-blue-400 border border-blue-500/50 px-3 py-1 rounded ml-2">4AEE</span>
            </h1>
            <div class="flex items-center gap-3 mt-2">
                <span id="view-mode-badge" class="text-[10px] font-bold bg-green-500/20 text-green-400 px-2 py-0.5 rounded border border-green-500/30 uppercase tracking-widest transition-colors duration-300">Live View</span>
            </div>
        </div>
        
        <div id="bathroom-status-bar" class="flex-grow mx-12 hidden md:flex justify-center"></div>

        <div class="flex items-center gap-4">
            <div class="relative group" onclick="window.openListModal()">
                <div class="text-[9px] uppercase font-bold text-slate-500 tracking-widest mb-1 text-right group-hover:text-blue-400 transition-colors">Consulta</div>
                <div class="glass-panel px-4 py-2 rounded-xl flex items-center gap-3 border border-slate-700 group-hover:border-blue-500/50 group-hover:shadow-[0_0_15px_rgba(59,130,246,0.15)] transition-all duration-300 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    <span class="font-mono text-sm font-bold text-slate-200 uppercase tracking-wider group-hover:text-white">ELENCO</span>
                </div>
            </div>

            <div class="relative group">
                <div class="text-[9px] uppercase font-bold text-slate-500 tracking-widest mb-1 text-right group-hover:text-blue-400 transition-colors">Seleziona Data</div>
                <div class="glass-panel px-4 py-2 rounded-xl flex items-center gap-3 border border-slate-700 group-hover:border-blue-500/50 group-hover:shadow-[0_0_15px_rgba(59,130,246,0.15)] transition-all duration-300 cursor-pointer relative overflow-hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span id="date-display" class="font-mono text-sm font-bold text-slate-200 uppercase tracking-wider group-hover:text-white">OGGI</span>
                    <input type="date" id="date-picker" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
            </div>

            <div class="glass-panel px-6 py-3 rounded-2xl text-right shadow-lg min-w-[140px]">
                <div id="clock" class="mono text-3xl font-bold text-blue-400 transition-colors duration-300">00:00:00</div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center w-full px-4 pb-32 relative">
        <div id="archive-warning" class="hidden w-full max-w-md bg-yellow-500/10 border border-yellow-500/50 rounded-lg p-3 mb-6 flex items-center justify-center gap-3 text-yellow-500 animate-fade-in">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
            <span class="text-xs font-black uppercase tracking-widest">Visualizzazione Storico</span>
        </div>

        <div class="w-full text-center mb-8 border-b border-dashed border-slate-700 pb-2">
            <span class="text-[10px] text-slate-600 font-bold uppercase tracking-[0.5em]">Fondo Aula</span>
        </div>

        <div class="grid grid-cols-3 gap-20 w-full max-w-[95%] mb-12">
            <div class="space-y-8 flex flex-col" id="col-1"></div>
            <div class="space-y-8 flex flex-col" id="col-2"></div>
            <div class="space-y-8 flex flex-col" id="col-3"></div>
        </div>

        <div class="w-72 h-20 bg-slate-800/90 border-b-4 border-blue-500 rounded-xl flex items-center justify-center shadow-[0_0_50px_-10px_rgba(59,130,246,0.3)] relative mt-4">
            <div class="absolute -top-6 w-32 h-2 bg-blue-500/20 blur-xl rounded-full"></div>
            <span class="text-lg font-black tracking-[0.4em] text-blue-400 uppercase">Cattedra</span>
        </div>
    </main>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-6xl glass-panel px-6 py-4 rounded-3xl flex flex-wrap justify-between items-center shadow-2xl z-40 gap-4 border border-slate-700/50">
        <div class="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-slate-300"><span class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span> Presente</div>
        <div class="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-slate-300"><span class="w-3 h-3 rounded-full bg-cyan-400 shadow-[0_0_10px_#22d3ee] animate-pulse"></span> Bagno</div>
        <div class="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-slate-300"><span class="w-3 h-3 rounded-full bg-orange-500 shadow-[0_0_10px_#f97316]"></span> Ritardo (>8:40)</div>
        <div class="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-slate-300"><span class="w-3 h-3 rounded-full bg-violet-500 shadow-[0_0_10px_#8b5cf6]"></span> 2° Ora (>9:45)</div>
        <div class="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-slate-300"><span class="w-3 h-3 rounded-full bg-yellow-400 shadow-[0_0_10px_#eab308]"></span> Uscita Ant. (<13:30)</div>
        <div class="flex items-center gap-3 text-xs font-bold uppercase tracking-widest text-slate-500"><span class="w-3 h-3 rounded-full border border-red-500 bg-red-500/20"></span> Assente</div>
    </div>

    <div id="student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
        <div class="bg-[#0f172a] border border-slate-600 w-full max-w-3xl rounded-3xl p-10 shadow-2xl transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="flex justify-between items-start mb-10 border-b border-slate-700 pb-6">
                <div><span class="text-sm text-blue-500 font-black uppercase tracking-[0.2em]" id="modal-date-label">Scheda Live</span><h2 id="modal-name" class="text-4xl font-black text-white mt-2 tracking-tight">Nome Cognome</h2></div>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white bg-slate-800 p-3 rounded-xl transition-all">✕</button>
            </div>
            <div class="grid grid-cols-2 gap-8 mb-10">
                <div class="bg-slate-800/40 p-6 rounded-2xl border border-slate-700 flex flex-col justify-center"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest mb-2">Stato Registrato</div><div id="modal-status" class="text-3xl font-black tracking-tight">--</div></div>
                <div class="bg-slate-800/40 p-6 rounded-2xl border border-slate-700 flex flex-col justify-center"><div class="text-xs text-slate-400 uppercase font-bold tracking-widest mb-2">Conteggio Uscite</div><div id="modal-count" class="text-3xl font-black text-white">0</div></div>
            </div>
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 pl-1">Storico Movimenti</h3>
            <div class="bg-slate-900 rounded-2xl overflow-hidden border border-slate-800 h-64 overflow-y-auto custom-scrollbar shadow-inner">
                <table class="w-full text-left"><thead class="bg-slate-800 text-xs text-slate-300 uppercase font-bold sticky top-0"><tr><th class="px-6 py-4">Uscita</th><th class="px-6 py-4">Rientro</th><th class="px-6 py-4 text-right">Durata</th></tr></thead><tbody id="modal-history-body" class="text-base font-mono text-slate-300 divide-y divide-slate-800/50"></tbody></table>
            </div>
        </div>
    </div>
    <div id="class-list-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay opacity-0 transition-opacity duration-300">
        <div class="bg-[#0f172a] border border-slate-600 w-full max-w-2xl rounded-3xl p-8 shadow-2xl transform scale-95 transition-transform duration-300" id="list-modal-content">
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4"><h2 class="text-2xl font-black text-white tracking-tight uppercase"><span class="text-blue-500">Elenco</span> Studenti</h2><button onclick="closeListModal()" class="text-slate-400 hover:text-white bg-slate-800 p-2 rounded-lg transition-all">✕</button></div>
            <div class="bg-slate-900/50 rounded-2xl overflow-hidden border border-slate-800 h-[60vh] overflow-y-auto custom-scrollbar"><ul id="class-list-ul" class="divide-y divide-slate-800"></ul></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- LOGIN LOGIC ---
        window.attemptLogin = function() {
            const pin = document.getElementById('pin-input').value;
            // PASSWORD: 4AEE (Cambiala qui se vuoi)
            if (pin === "4AEE") {
                const loginScreen = document.getElementById('login-screen');
                loginScreen.style.opacity = '0';
                setTimeout(() => { loginScreen.style.display = 'none'; }, 700);
                sessionStorage.setItem('isLogged', 'true');
            } else {
                const errorMsg = document.getElementById('login-error');
                const input = document.getElementById('pin-input');
                errorMsg.classList.remove('hidden');
                input.value = "";
                input.classList.add('border-red-500');
                setTimeout(() => input.classList.remove('border-red-500'), 1000);
            }
        };

        // Check Login al caricamento
        if(sessionStorage.getItem('isLogged') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
        }

        // Tasto Invio per Login
        document.getElementById('pin-input').addEventListener("keypress", function(e) {
            if (e.key === "Enter") attemptLogin();
        });

        // --- DASHBOARD LOGIC ---
        let currentClassData = {};
        const todayStr = new Date().toISOString().split('T')[0]; 
        let selectedDate = todayStr;
        const datePicker = document.getElementById('date-picker');
        const dateDisplay = document.getElementById('date-display');
        datePicker.value = todayStr; datePicker.max = todayStr;

        datePicker.addEventListener('change', (e) => {
            selectedDate = e.target.value;
            dateDisplay.innerText = (selectedDate === todayStr) ? "OGGI" : new Date(selectedDate).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
            loadDataForDate(selectedDate);
            updateInterfaceMode(selectedDate);
        });

        function updateInterfaceMode(date) {
            const isToday = (date === todayStr);
            const badge = document.getElementById('view-mode-badge');
            const archiveWarning = document.getElementById('archive-warning');
            const clock = document.getElementById('clock');
            if (isToday) { badge.innerText = "LIVE VIEW"; badge.className = "text-[10px] font-bold bg-green-500/20 text-green-400 px-2 py-0.5 rounded border border-green-500/30 uppercase tracking-widest"; archiveWarning.classList.add('hidden'); clock.className = "mono text-3xl font-bold text-blue-400"; } 
            else { badge.innerText = "ARCHIVIO STORICO"; badge.className = "text-[10px] font-bold bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded border border-yellow-500/30 uppercase tracking-widest"; archiveWarning.classList.remove('hidden'); clock.className = "mono text-3xl font-bold text-yellow-400"; }
        }

        function loadDataForDate(date) { const isDifferentDay = (date !== todayStr); renderClassroom(generateDemoData(isDifferentDay)); }

        function renderClassroom(data) {
            currentClassData = data;
            const labels = ["ALA SINISTRA", "FILA CENTRALE", "ALA DESTRA"];
            for(let c=1; c<=3; c++) document.getElementById(`col-${c}`).innerHTML = `<div class="text-center text-xs text-slate-600 font-bold uppercase tracking-[0.2em] mb-4 opacity-50">${labels[c-1]}</div>`;

            let studentOut = null;
            for (const [key, val] of Object.entries(data)) { if (val.stato === 'bagno') { studentOut = val.nome; break; } }
            const statusDiv = document.getElementById('bathroom-status-bar');
            if (studentOut) {
                statusDiv.innerHTML = `<div class="px-6 py-2 rounded-full border border-yellow-500/50 bg-yellow-900/30 flex items-center gap-3 animate-pulse"><div class="w-3 h-3 rounded-full bg-yellow-500 shadow-[0_0_10px_#eab308]"></div><span class="text-xs font-black text-yellow-400 uppercase tracking-widest">BAGNO OCCUPATO: <span class="text-white">${studentOut}</span></span></div>`;
            } else {
                statusDiv.innerHTML = `<div class="px-6 py-2 rounded-full border border-green-500/30 bg-green-900/20 flex items-center gap-3"><div class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div><span class="text-xs font-black text-green-400 uppercase tracking-widest">BAGNO LIBERO</span></div>`;
            }

            let globalSeatIndex = 1;
            for (let col = 1; col <= 3; col++) {
                const colContainer = document.getElementById(`col-${col}`);
                let rowsHTML = []; 
                for (let row = 1; row <= 4; row++) {
                    const isSingleDesk = (col === 2 && row === 1);
                    const deskPair = document.createElement('div');
                    deskPair.className = isSingleDesk ? "flex justify-center w-full" : "grid grid-cols-2 gap-1"; 
                    const seatsInRow = isSingleDesk ? 1 : 2;

                    for (let seat = 1; seat <= seatsInRow; seat++) {
                        const seatId = `banco_${String(globalSeatIndex).padStart(2, '0')}`;
                        const student = data[seatId] || { nome: "Libero", stato: "assente" };
                        
                        let statusClass = "status-assente"; let statusLabel = "ASSENTE";
                        switch(student.stato) {
                            case 'presente': statusClass = "status-presente"; statusLabel = "IN CLASSE"; break;
                            case 'bagno': statusClass = "status-bagno"; statusLabel = "FUORI"; break;
                            case 'ritardo': statusClass = "status-ritardo"; statusLabel = "RITARDO"; break;
                            case 'uscita_anticipata': statusClass = "status-uscita"; statusLabel = "USCITA ANT."; break;
                            case 'seconda_ora': statusClass = "status-seconda-ora"; statusLabel = "ENTRATA 2° ORA"; break;
                        }

                        const widthClass = isSingleDesk ? "w-[50%]" : "";
                        const exitCount = student.storico ? student.storico.length : 0;
                        const isMaxExits = exitCount >= 2;
                        let exitTextClass = "text-slate-400"; let exitLabel = `${exitCount}/2 USCITE`;
                        if (isMaxExits) { exitTextClass = "text-red-500 animate-pulse"; exitLabel = "2/2 (MAX)"; } else if (exitCount === 1) { exitTextClass = "text-yellow-400"; }

                        const cardHTML = `
                            <div onclick="window.openModal('${seatId}')" class="${widthClass} relative h-40 rounded-lg p-3 flex flex-col justify-between transition-all duration-200 cursor-pointer hover:scale-105 active:scale-95 shadow-lg ${statusClass}">
                                <div class="flex justify-between items-start">
                                    <span class="text-[10px] font-bold opacity-60 bg-black/30 px-2 py-0.5 rounded-md">#${globalSeatIndex}</span>
                                    <span class="text-[9px] font-black uppercase tracking-wider opacity-90">${statusLabel}</span>
                                </div>
                                <div class="text-center flex-grow flex items-center justify-center px-1">
                                    <h3 class="font-black text-xl leading-tight uppercase drop-shadow-md break-words w-full">${student.nome}</h3>
                                </div>
                                <div class="flex flex-col items-center gap-1">
                                    <span class="text-[10px] font-bold bg-black/20 px-2 py-0.5 rounded font-mono text-slate-300">${student.orario || "--:--"}</span>
                                    <span class="text-[9px] font-black uppercase tracking-widest ${exitTextClass}">${exitLabel}</span>
                                </div>
                            </div>`;
                        deskPair.innerHTML += cardHTML;
                        globalSeatIndex++;
                    }
                    rowsHTML.push(deskPair);
                }
                rowsHTML.reverse().forEach(r => colContainer.appendChild(r));
            }
        }

        function updateTime() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('it-IT'); }
        setInterval(updateTime, 1000); updateTime();

        window.openListModal = function() {
            const modal = document.getElementById('class-list-modal'); const content = document.getElementById('list-modal-content'); const listUl = document.getElementById('class-list-ul');
            let students = [];
            for (const [key, val] of Object.entries(currentClassData)) {
                if (val.nome !== "Libero") {
                    const parts = val.nome.split(' ');
                    const firstName = parts[0];
                    const lastName = parts.slice(1).join(' ');
                    students.push({ id: key, ...val, firstName, lastName });
                }
            }
            students.sort((a, b) => a.lastName.localeCompare(b.lastName));
            listUl.innerHTML = "";
            students.forEach(s => {
                let colorClass = "text-slate-400"; if(s.stato === 'presente') colorClass = "text-green-400"; if(s.stato === 'bagno') colorClass = "text-cyan-400"; if(s.stato === 'ritardo') colorClass = "text-orange-400"; if(s.stato === 'uscita_anticipata') colorClass = "text-yellow-400"; if(s.stato === 'assente') colorClass = "text-red-500";
                if(s.stato === 'seconda_ora') colorClass = "text-violet-400";
                const deskNum = s.id.split('_')[1]; const highlight = s.nome === "Antonio Navarroli" ? "bg-blue-900/30 border-blue-500/50" : "hover:bg-slate-800 border-transparent";
                listUl.innerHTML += `<li onclick="window.closeListModal(); window.openModal('${s.id}')" class="p-4 flex justify-between items-center cursor-pointer transition-colors group border-b border-slate-800 ${highlight}"><div class="flex items-center gap-4"><span class="font-mono text-xs text-slate-600 bg-slate-900 border border-slate-700 px-2 py-1 rounded">#${deskNum}</span><span class="text-lg text-white group-hover:text-blue-300 transition-colors"><span class="font-black uppercase">${s.lastName}</span> <span class="font-normal opacity-80">${s.firstName}</span></span></div><div class="flex items-center gap-2"><span class="text-[10px] font-black uppercase tracking-wider ${colorClass}">${s.stato.replace('_', ' ')}</span><span class="w-2 h-2 rounded-full ${colorClass.replace('text-', 'bg-')}"></span></div></li>`;
            });
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
        };
        window.closeListModal = function() { const modal = document.getElementById('class-list-modal'); const content = document.getElementById('list-modal-content'); modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); };
        window.openModal = function(seatId) {
            const student = currentClassData[seatId]; if (!student || student.nome === "Libero") return;
            const modal = document.getElementById('student-modal'); const content = document.getElementById('modal-content'); const historyBody = document.getElementById('modal-history-body');
            document.getElementById('modal-date-label').innerText = (selectedDate === todayStr) ? "SCHEDA LIVE (OGGI)" : `STORICO DEL ${selectedDate}`; document.getElementById('modal-name').innerText = student.nome;
            const statusEl = document.getElementById('modal-status'); statusEl.innerText = student.stato.toUpperCase().replace('_', ' '); 
            statusEl.className = "text-3xl font-black tracking-tight " + (
                student.stato === 'presente' ? 'text-green-400' : 
                student.stato === 'bagno' ? 'text-cyan-400' : 
                student.stato === 'ritardo' ? 'text-orange-400' : 
                student.stato === 'seconda_ora' ? 'text-violet-400' :
                student.stato === 'uscita_anticipata' ? 'text-yellow-400' : 'text-red-400');
            const history = student.storico || []; document.getElementById('modal-count').innerText = history.length; historyBody.innerHTML = ""; if (history.length === 0) { historyBody.innerHTML = `<tr><td colspan="3" class="px-6 py-6 text-center text-slate-500 italic text-sm">Nessuna uscita registrata</td></tr>`; } else { history.forEach(h => { historyBody.innerHTML += `<tr class="hover:bg-slate-800/50 transition-colors"><td class="px-6 py-4 text-cyan-500 font-bold">${h.uscita}</td><td class="px-6 py-4 text-green-500 font-bold">${h.rientro || "---"}</td><td class="px-6 py-4 text-right text-slate-400">${h.rientro ? calculateDuration(h.uscita, h.rientro) : "<span class='animate-pulse text-yellow-500'>In corso...</span>"}</td></tr>`; }); }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
        };
        window.closeModal = function() { const modal = document.getElementById('student-modal'); const content = document.getElementById('modal-content'); modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); };
        document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', function(e) { if (e.target === this) { window.closeModal(); window.closeListModal(); } }));
       
       
       
        // Funzione Helper per calcolare la differenza in minuti
        function calcolaDurata(orarioUscita, orarioRientro) {
        if (!orarioUscita || !orarioRientro || orarioRientro === '--:--') return "";
    
        const [hOut, mOut] = orarioUscita.split(':').map(Number);
        const [hIn, mIn] = orarioRientro.split(':').map(Number);
    
        // Converte tutto in minuti
        const minutiOut = hOut * 60 + mOut;
        const minutiIn = hIn * 60 + mIn;
    
        let diff = minutiIn - minutiOut;
    
        // Gestione caso cambio giorno (es. esce alle 23:55 rientra alle 00:05)
        if (diff < 0) diff += 1440; 
    
        return `${diff} min`;
}
        
        const classroomMap = {
            "banco_01": "Emiliano Calò", "banco_02": "Antonio Navarroli", "banco_03": "Filippo Agnitti", "banco_04": "Ivan Garofalo",
            "banco_05": "Mattia Galli", "banco_06": "Lorenzo Esposito", "banco_07": "Kristian Methasa", "banco_08": "Stefano Spaczil",
            "banco_09": "Federico Pasqualone", "banco_10": "Leonardo Pacchione", "banco_11": "Oleksandr Tsikhanskyi", "banco_12": "Alessio Tofano", "banco_13": "Pierpaolo Carosa", "banco_14": "Stefano Camassa", "banco_15": "Lorenzo Pisone", "banco_16": "Abdula Chackari", "banco_17": "Ernest Cupi", "banco_18": "Matteo Di Michele", "banco_19": "Luca Iarossi", "banco_20": "Biagio Recchione", "banco_21": "Luigi Mirandola", "banco_22": "Mattia Raulli", "banco_23": "Giuseppe Palombizio"
        };

        const generateDemoData = (simulateHistory = false) => {
            let data = {};
            let studentOut = false;
            for (let i = 1; i <= 23; i++) {
                const id = `banco_${String(i).padStart(2, '0')}`; const name = classroomMap[id] || "Libero";
                let rand = simulateHistory ? Math.random() * 0.5 : Math.random(); 
                let stato = "presente"; let orario = "08:00"; let storico = [];
                
                if (rand > 0.9 && !studentOut) { stato = "bagno"; storico.push({ uscita: "09:00", rientro: "09:05" }, { uscita: "10:30", rientro: null }); studentOut = true; }
                else if (rand > 0.8) { storico.push({ uscita: "09:00", rientro: "09:05" }, { uscita: "10:30", rientro: "10:35" }); }
                else if (rand > 0.75) { stato = "ritardo"; orario = "08:50"; }
                // DEMO 2° ORA
                else if (rand > 0.65) { stato = "seconda_ora"; orario = "09:50"; }
                else if (rand > 0.95) { stato = "assente"; orario = "--:--"; }
                else if (simulateHistory && rand < 0.2) { stato = "uscita_anticipata"; orario = "12:15"; }
                data[id] = { nome: name, stato: stato, orario: orario, storico: storico };
            }
            return data;
        };
        const USE_FIREBASE = false;
        loadDataForDate(todayStr); 
    </script>
</body>
</html>
